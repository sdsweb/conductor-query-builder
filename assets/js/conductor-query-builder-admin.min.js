/**
 * Conductor Query Builder Admin
 */

var conductor_query_builder=conductor_query_builder||{}
!function(e,t){"use strict"
var r,o,n,i,s,c,u,a,l,d,p,b,h,f
conductor_query_builder.hasOwnProperty("Backbone")||(conductor_query_builder.Backbone={Views:{},Models:{},Collections:{},instances:{models:{clauses:[],sub_clauses:[],shortcode:[]},collections:{clauses:[],sub_clauses:[],shortcode:[]},views:{clauses:[],sub_clauses:[],clause_action_buttons:[]}},defaults:{meta:{parameters:!1,operators:!1,values:!1},parent:{count:-1,id:"",limit:-1}}}),conductor_query_builder.hasOwnProperty("fn")||(conductor_query_builder.fn={query_builder:{init:function(e){e=e||!1
var r=t(".widget","#widgets-right"),o=r.find(".conductor-accordion-section")
u=new conductor_query_builder.Backbone.Collections.Query_Builder_Clause_Group,conductor_query_builder.Backbone.instances.collections.clauses=u,a=new conductor_query_builder.Backbone.Collections.Query_Builder_Sub_Clause_Group,conductor_query_builder.Backbone.instances.collections.sub_clauses=a,s=new conductor_query_builder.Backbone.Views.Query_Builder({type:"query-builder",shortcode:e}),conductor_query_builder.Backbone.instances.views.query_builder=s,c=new conductor_query_builder.Backbone.Views.Query_Builder_Actions({type:"query-builder-actions",shortcode:e}),conductor_query_builder.Backbone.instances.views.query_builder_actions=c,s.views.set(c.el_selector,c,{silent:!0}),s.render(),setTimeout(function(){o.each(function(){var e=t(this),r=e.find(".conductor-accordion-section-title"),o=e.find(".conductor-accordion-section-content")
r.length&&!e.hasClass("open")&&o.slideToggle(0)}),i=new conductor_query_builder.Backbone.Views.Query_Builder_Wrapper({type:"query-builder-wrapper",shortcode:e}),conductor_query_builder.Backbone.instances.views.query_builder_wrapper=i},1)},reset:function(e){s.reset(),void 0!==e&&(conductor_query_builder.meta=e),s.render()}},shortcode:{init:function(){d=new conductor_query_builder.Backbone.Collections.Shortcode,conductor_query_builder.Backbone.instances.collections.shortcode.push(d),l=new conductor_query_builder.Backbone.Models.Shortcode,d.add(l),conductor_query_builder.Backbone.instances.models.shortcode.push(l),p=new conductor_query_builder.Backbone.Views.Shortcode({model:l,queries:conductor_query_builder.queries,type:"shortcode"}),conductor_query_builder.Backbone.instances.views.shortcode=p,b=new conductor_query_builder.Backbone.Views.Shortcode_Actions({type:"shortcode-actions",button_type:"insert",label:conductor_query_builder.l10n.shortcode.insert}),conductor_query_builder.Backbone.instances.views.shortcode_actions=b,p.views.set(b.el_selector,b,{silent:!0}),h=new conductor_query_builder.Backbone.Views.Shortcode_Insert({queries:p.options.queries,type:"shortcode-insert"}),conductor_query_builder.Backbone.instances.views.shortcode_insert=h,p.views.set(h.el_selector,h,{silent:!0}),f=new conductor_query_builder.Backbone.Views.Shortcode_Create_Title({type:"shortcode-create-title",title:conductor_query_builder.title||""}),conductor_query_builder.Backbone.instances.views.shortcode_create_title=f,p.views.set(f.el_selector,f,{silent:!0}),p.render()},reset:function(){p.reset(),h.reset()}},conductor:{widget:{reset:function(e){e=e||{}
var r,o=!1,n=[]
setTimeout(function(){r=p.$el.find(".conductor-widget-setting :input"),r.length&&(r.each(function(){var e,r=t(this),i=this.nodeName.toLowerCase(),s="input"===i?r.attr("type"):null,c="checkbox"===s||"radio"===s?r.data("default"):null,u=c?null:r.data("default-value")
if(null!==c||null!==u&&void 0!==u||(u=r.parents(".conductor-widget-setting").data("default-value")),null!==c||null!==u&&void 0!==u)if(r.hasClass("conductor-output-data"))r.val(JSON.stringify(u)),_.each(u,function(e,t){var r,i
switch(o=p.$el.find('[data-id="'+e.id+'"]'),n.push(e.id),e.id){case"post_content":o.find(".conductor-widget-output-element-label-select select").val(e.value)}o.addClass("visible"),o.data("visible","true").attr("data-visible","true"),e.link&&(o.addClass("link"),o.data("link","true").attr("data-link","true")),r=o.find(".conductor-widget-output-element-label .label"),i=o.find(".conductor-widget-output-element-label-input input"),r.length?r.parent().removeClass("editing"):(r=o.find(".conductor-widget-output-element-label"),r.removeClass("editing")),r.length&&(r.html(e.label),i.length&&i.val("").data("current","").attr("data-current",""),o.data("label",e.label).attr("data-label",e.label)),o.data("priority",t).attr("data-priority",t),p.$el.find(".conductor-widget-output-list").append(o)}),p.$el.find(".conductor-widget-output-element").each(function(){var e=t(this);-1===n.indexOf(e.data("id"))&&e.remove()})
else if(null!==s)switch(s){case"checkbox":case"radio":e=r.prop("checked"),r.prop("checked",c),e!==c&&r.trigger("change")
break
default:r.val(u).trigger("change").trigger("input")}else switch(i){case"select":r.val(u).trigger("change")}}),p.$el.find(".conductor-select-feature-type").trigger("change"))},1)}}}}),conductor_query_builder.Backbone.Models.Query_Builder_Clause_Group=Backbone.Model.extend({defaults:{columns:!1,el_selector:"",flags:[],operators:[],parameters:[],title:"",limit:-1,type:!1},id_prefix:"conductor-qb-",initialize:function(){_.bindAll(this,"setID","removeFromInstances"),this.listenTo(this,"remove",this.removeFromInstances),this.listenTo(this,"remove",this.stopListening)},setID:function(e){-1!==e.options.count&&this.set("id",this.getIDFromView(e))},getIDFromView:function(e){return this.id_prefix+this.get("type")+"-"+e.options.count},removeFromInstances:function(){var e,t=conductor_query_builder.Backbone.instances.models.clauses,r=this
e=t.map(function(e){return e.get("id")}).indexOf(r.get("id")),-1!==e&&t.splice(e,1)}}),conductor_query_builder.Backbone.Models.Query_Builder_Sub_Clause_Group=Backbone.Model.extend({defaults:{columns:!1,config:{},flags:[],meta:_.clone(conductor_query_builder.Backbone.defaults.meta),operators:[],parameters:[],parent_id:"",parent:_.clone(conductor_query_builder.Backbone.defaults.parent),title:"",type:!1},id_prefix:"conductor-qb-",initialize:function(){_.bindAll(this,"setID","setParentID","removeFromInstances"),this.listenTo(this,"remove",this.removeFromInstances),this.listenTo(this,"remove",this.stopListening)},setID:function(e,t){t=t||!1,e.views.parent&&e.views.parent.model&&-1!==e.options.count&&(this.setParentID(e.views.parent.model.get("id")),this.set("id",t?t:this.getIDFromView(e)))},getIDFromView:function(e){return this.id_prefix+e.views.parent.model.get("id").replace(this.id_prefix,"")+"-"+e.options.count},setParentID:function(e){var t=_.clone(this.get("parent"))
t.id=e,this.set("parent",t),this.set("parent_id",e)},setParentData:function(e){var t=_.clone(this.get("parent"))
t.count=e.views.parent.options.count,t.limit=e.views.parent.model.get("limit"),this.set("parent",t)},removeFromInstances:function(){var e,t=conductor_query_builder.Backbone.instances.models.sub_clauses,r=this
e=t.map(function(e){return e.get("id")}).indexOf(r.get("id")),-1!==e&&t.splice(e,1)}}),conductor_query_builder.Backbone.Collections.Query_Builder_Clause_Group=Backbone.Collection.extend({}),conductor_query_builder.Backbone.Collections.Query_Builder_Sub_Clause_Group=Backbone.Collection.extend({isMetaEmpty:function(){return"advanced"!==window.getUserSetting(conductor_query_builder.user.settings["query-builder"].mode.name)?!0:this.every(function(e){var t=e.get("meta")
return!t.parameters&&!t.operators&&!t.values})}}),conductor_query_builder.Backbone.Views.Query_Builder_Wrapper=e.Backbone.View.extend({el:"#conductor-qb-query-builder",has_user_changed_feature_type:!1,feature_type_value:"",events:{"change .conductor-select-feature-type":"setHasUserChangedFeatureTypeFlag","change :input":"previewQuery","keyup :input":"previewQuery","change .conductor-widget-size-value":"maybeShowConductorWidgetColumnsSetting"},initialize:function(e){_.bindAll(this,"render","setHasUserChangedFeatureTypeFlag","previewQuery")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this},setHasUserChangedFeatureTypeFlag:function(e){this.feature_type_value=t(e.currentTarget).val(),this.has_user_changed_feature_type||(this.has_user_changed_feature_type=!0)},previewQuery:_.debounce(function(r){var o=t(document),i=r&&t(r.currentTarget)
this.options.shortcode||i&&i.length&&!i.hasClass("conductor-qb-select2")&&i.data("conductor-query-builder-skip-preview")||i&&i.length&&i.hasClass("select2-search__field")&&i.parents(".select2-container").prev(".conductor-qb-select2").data("conductor-query-builder-skip-preview")||(o.trigger("conductor-query-builder-preview-query",[this,n]),n.addClass(conductor_query_builder.css.classes.loading).html(""),this.ajax.current_request&&this.ajax.current_request.abort(),this.ajax.current_request=e.ajax.post(conductor_query_builder.ajax.preview.action,this.ajax.setupAJAXData(conductor_query_builder.ID,conductor_query_builder.ajax.preview.nonce,conductor_query_builder.ajax.preview.action)).done(this.ajax.success).fail(this.ajax.fail))},400),maybeShowConductorWidgetColumnsSetting:function(e){var r=t(e.currentTarget),o=r.val(),n=conductor.widgets.conductor.displays,i=o&&n&&n[o]&&_.isObject(n[o])?n[o]:!1,s=r.parents(".widget"),c=s.find(".conductor-columns"),u=window.getUserSetting(conductor_query_builder.user.settings["query-builder"].mode.name)
u&&"advanced"===u&&setTimeout(function(){conductor.widgets.conductor.renderElement(c,s,r,{display:{supports:"columns",config:i?i:{}},feature_type:"true"})},1)},ajax:{current_request:!1,setupAJAXData:function(e,r,o,n){n=n||i.$el.find(":input")
var s=t.extend({ID:e,nonce:r,nonce_action:o},this.data),c=n.serializeArray()
return _.each(c,function(e){var r=t('[name="'+e.name+'"]'),o=r.data("type"),n=r.prop("multiple"),i=e.value
r[0].nodeName.toLowerCase()&&"values"===o&&n&&(i=r.data("selected-options")),s[e.name]?(_.isArray(s[e.name])||(s[e.name]=[s[e.name]]),-1===s[e.name].indexOf(e.value)&&s[e.name].push(e.value)):s[e.name]=i}),s},success:function(e){n.removeClass(conductor_query_builder.css.classes.loading),e.preview&&n.html(e.preview)},fail:function(e){e.statusText&&"abort"===e.statusText||n.removeClass(conductor_query_builder.css.classes.loading).html(conductor_query_builder.l10n.ajax.fail.preview)}}}),conductor_query_builder.Backbone.Views.Query_Builder=e.Backbone.View.extend({el:"#conductor-qb-meta-box-query-builder-tab-content",query_builder_mode_attr:"data-query-builder-mode",initial_feature_type:!1,has_user_changed_feature_type:!1,initialize:function(e){var t,r,o=this,n=window.getUserSetting(conductor_query_builder.user.settings["query-builder"].mode.name)
_.bindAll(this,"render"),setTimeout(function(){t=o.options.shortcode?p:i,r=t.$el.find(".conductor-select-feature-type"),o.initial_feature_type=r.val(),"advanced"===n&&"true"!==r.val()&&r.val("true").trigger("change")},100)},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this.renderClauseGroups(),this},renderClauseGroups:function(){var e,t=this
setTimeout(function(){_.each(conductor_query_builder.clauses,function(t,r){(t.config["default"]||conductor_query_builder.meta[r]&&!_.isEmpty(conductor_query_builder.meta[r]))&&(t.config["default"]?c.addClauseGroup(!1,r,t,conductor_query_builder.meta[r]):_.each(conductor_query_builder.meta[r],function(o,n){e=c.addClauseGroup(!1,r,t,conductor_query_builder.meta[r]),_.each(o,function(t,r){0!==r&&e.addSubClauseGroup()})}))}),t.removeLoadingState()},1)},reset:function(){var e,t,r,o=this
for(_.each(conductor_query_builder.meta,function(e,t){conductor_query_builder.meta[t]=[]}),c.trigger("conductor-qb-disable-action-buttons"),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.trigger("conductor-qb-disable-action-buttons")});u.length;)e=u.first(),t=e.get("el_selector"),t&&(r=o.views.get(t),r.length&&_.each(r,function(e){e.removeClauseGroup(!1,!0)}))},toggleQueryBuilderMode:function(e,t){var r=this.options.shortcode?p:i,o=r.$el.find(".conductor-select-feature-type")
this.$el.find("["+this.query_builder_mode_attr+'="'+t+'"]').addClass("hide hidden conductor-qb-hide conductor-qb-hidden"),this.$el.find("["+this.query_builder_mode_attr+'="'+e+'"]').removeClass("hide hidden conductor-qb-hide conductor-qb-hidden"),this.$el.parents(".conductor-qb-query-builder-meta-box-tab-content-wrapper").toggleClass("conductor-qb-"+t+"-mode conductor-qb-"+e+"-mode"),"advanced"===e&&"true"!==o.val()?o.val("true").trigger("change"):"simple"===e&&(r.has_user_changed_feature_type?o.val(r.feature_type_value).trigger("change"):o.val("").trigger("change")),this.$el.trigger("conductor-qb-toggle-query-builder-mode",[e,t]),this.trigger("conductor-qb-toggle-query-builder-mode",e,t)},removeLoadingState:function(){this.$el.parents(".conductor-qb-query-builder-meta-box-tab-content-wrapper").removeClass(conductor_query_builder.css.classes.loading)}}),conductor_query_builder.Backbone.Views.Query_Builder_Actions=e.Backbone.View.extend({className:"conductor-qb-meta-box-query-builder-actions-inner",action_button_selector:".conductor-qb-action-button",el_selector:"",el_selector_prefix:".conductor-qb-meta-box-query-builder-",el_selector_suffix:"-actions",flags:{action_buttons_enabled:!1},template:e.template("conductor-qb-meta-box-query-builder-actions"),events:{"click .conductor-qb-add-clause-group-button":function(e){var r,o=t(e.currentTarget),n=o.data("clause-group-type"),i=this.options.clause_group_type,s=conductor_query_builder.clauses[n]&&conductor_query_builder.clauses[n].config,c=conductor_query_builder.Backbone.instances.views.sub_clauses,u=c.map(function(e){return e.options.type}).indexOf(i),a=-1!==u?c[u]:!1,l=a&&a.getMeta(),d=a&&a.getConfig(),p=s&&s.limit?parseInt(s.limit,10):-1,b=!1
return _.find(d,function(e,t){return e.clauses&&l.parameters&&(_.isArray(l.parameters)&&-1!==l.parameters.indexOf(t)||l.parameters===t)&&_.find(e.clauses,function(e,t){return t===n&&e.disabled&&(b=!0),b}),b}),!b&&d&&d.action_buttons&&d.action_buttons[n]&&_.find(d.action_buttons[n].columns,function(e,t){switch(t){case"parameters":_.find(e,function(e,t){return l.parameters&&(_.isArray(l.parameters)&&-1!==l.parameters.indexOf(t)||l.parameters===t)&&e.disabled&&(b=!0),b})}return b}),b?void e.preventDefault():(r=this.addClauseGroup(e),void(r&&-1!==p&&r.getCurrentCount()>=p&&this.disableActionButton("#"+o.attr("id"))))},"click .conductor-qb-test-query-button":"testQuery","click .conductor-qb-toggle-mode-button":"toggleQueryBuilderMode"},initialize:function(e){_.bindAll(this,"render","addClauseGroup"),e.flags||(e.flags={}),this.el_selector=e.clause_group_type?this.el_selector_prefix+e.clause_group_type+this.el_selector_suffix:this.el_selector_prefix+this.el_selector_suffix,e.clause_group_type&&!t(this.el_selector).length&&(this.el_selector=this.el_selector_prefix+e.clause_group_type.replace("_","-")+this.el_selector_suffix),e.clause_group_type||(this.el_selector=this.el_selector.replace("--","-")),!e.flags.clause_group&&e.clause_group_type&&(e.flags.clause_group=!0),this.listenTo(this,"conductor-qb-enable-action-buttons",this.enableActionButtons),this.listenTo(this,"conductor-qb-disable-action-buttons",this.disableActionButtons)},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this},addClauseGroup:function(e,r,o,n){r=r||!1,o=o||!1,n=n||!1
var i,c,a,l,d=e&&!_.isEmpty(e),p=d&&e.currentTarget?t(e.currentTarget):!1,b=r?r:p?p.data("clause-group-type"):!1,h=o.config,f=h&&h.title||"",g=h&&h.limit?parseInt(h.limit,10):-1
return d&&e.preventDefault(),b?(i=new conductor_query_builder.Backbone.Models.Query_Builder_Clause_Group({columns:conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].config&&conductor_query_builder.clauses[b].config.columns?conductor_query_builder.clauses[b].config.columns:!1,flags:conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].config&&conductor_query_builder.clauses[b].config.flags?conductor_query_builder.clauses[b].config.flags:!1,operators:conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].operators?conductor_query_builder.clauses[b].operators:!1,parameters:conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].parameters?conductor_query_builder.clauses[b].parameters:!1,meta:n?n:conductor_query_builder.meta[b]?conductor_query_builder.meta[b]:_.clone(conductor_query_builder.Backbone.defaults.meta),title:!f&&conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].config&&conductor_query_builder.clauses[b].config.title?conductor_query_builder.clauses[b].config.title:f,type:b,limit:!isNaN(g)&&g>0?g:-1,shortcode:this.options.shortcode}),u.add(i),conductor_query_builder.Backbone.instances.models.clauses.push(i),c=_.clone(i.attributes),c.model=i,a=new conductor_query_builder.Backbone.Views.Query_Builder_Clause_Group(c),conductor_query_builder.Backbone.instances.views.clauses.push(a),i.setID(a),c.flags.actions&&(l=new conductor_query_builder.Backbone.Views.Query_Builder_Actions(_.defaults({type:"query-builder-actions",clause_group_type:c.type},_.clone(c))),conductor_query_builder.Backbone.instances.views.clause_action_buttons.push(l),a.views.set(l.el_selector,l,{silent:!0})),s.views.add(a.el_selector,a),a):!1},enableActionButtons:function(){this.flags.action_buttons_enabled=!0,this.enableActionButton(this.action_button_selector)},enableActionButton:function(e){var r=this.$el.find(e),o=this.options.clause_group_type,n=conductor_query_builder.Backbone.instances.views.sub_clauses,i=n.map(function(e){return e.options.type}).indexOf(o),s=-1!==i?n[i]:!1,c=s&&s.getMeta(),a=(s&&s.options.type,s&&s.getConfig()),l=conductor_query_builder.clauses[o]&&conductor_query_builder.clauses[o].config
r.length||(e=e.replace("_","-"),r=this.$el.find(e)),r.length&&(r.length>1?r.each(function(){var e,r=t(this),o=r.data("clause-group-type"),n=conductor_query_builder.clauses[o]&&conductor_query_builder.clauses[o].config,i=n&&n.limit?parseInt(n.limit,10):-1,s=u.where({type:o}).length,d=!1
0===s&&conductor_query_builder.meta[o]&&(s=conductor_query_builder.meta[o].length),e=-1===i||i>s,e&&(_.find(a,function(e,t){return e.clauses&&c.parameters&&(_.isArray(c.parameters)&&-1!==c.parameters.indexOf(t)||c.parameters===t)&&_.find(e.clauses,function(e,t){return t===o&&e.disabled&&(d=!0),d}),d}),!d&&l&&l.action_buttons&&l.action_buttons[o]&&_.find(l.action_buttons[o].columns,function(e,t){switch(t){case"parameters":_.find(e,function(e,t){return c.parameters&&(_.isArray(c.parameters)&&-1!==c.parameters.indexOf(t)||c.parameters===t)&&e.disabled&&(d=!0),d})}return d})),d&&e&&(e=!1),e?r.prop("disabled",!1):e||!d||r.prop("disabled")||r.prop("disabled","disabled")}):r.prop("disabled",!1))},disableActionButtons:function(){this.flags.action_buttons_enabled=!1,this.disableActionButton(this.action_button_selector)},disableActionButton:function(e){var t=this.$el.find(e)
t.length&&t.prop("disabled",!0)},testQuery:function(e){e.preventDefault()},toggleQueryBuilderMode:function(e){var r,o=t(e.currentTarget),n=conductor_query_builder.user.settings["query-builder"].mode.value
e.preventDefault(),r=_.find(conductor_query_builder.user.settings["query-builder"].mode.values,function(e,t){return conductor_query_builder.user.settings["query-builder"].mode.values.indexOf(n)!==t}),o.html(o.data(r+"-label")),window.setUserSetting(conductor_query_builder.user.settings["query-builder"].mode.name,r),conductor_query_builder.user.settings["query-builder"].mode.value=r,this.$el.trigger("conductor-qb-toggle-query-builder-mode",[r,n]),this.trigger("conductor-qb-toggle-query-builder-mode",r,n),s.toggleQueryBuilderMode(r,n)}}),conductor_query_builder.Backbone.Views.Query_Builder_Clause_Group=e.Backbone.View.extend({className:"conductor-qb-meta-box-query-builder-clause-group-inner",el_selector:"",el_selector_prefix:".conductor-qb-meta-box-query-builder-",el_selector_suffix:"-groups",select2_selector:".conductor-qb-select2",$select2:!1,template:e.template("conductor-qb-meta-box-query-builder-clause-group"),events:{"click .conductor-qb-remove-action-button":function(e){var r,o,n,i=t(e.currentTarget),s="#"+i.data("action-button-id"),u=t(s)
u.length||(s=s.replace("_","-"),u=t(s)),u.length&&(o=u.data("clause-group-type"),r=conductor_query_builder.clauses[o]&&conductor_query_builder.clauses[o].config,n=r&&r.limit?parseInt(r.limit,10):-1),c.flags.action_buttons_enabled&&n&&this.getCurrentCount()<=n&&(c.enableActionButton(s),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.enableActionButton(s)})),this.removeClauseGroup(e)},"click .conductor-qb-add-action-button":"addSubClauseGroup"},initialize:function(e){_.bindAll(this,"render","addSubClauseGroup","removeSubClauseGroup","removeClauseGroup","select2Change","getCurrentCount"),e.flags||(e.flags={}),e.type&&(this.el_selector=this.el_selector_prefix+e.type+this.el_selector_suffix,t(this.el_selector).length||(this.el_selector=this.el_selector_prefix+e.type.replace("_","-")+this.el_selector_suffix),this.model.set("el_selector",this.el_selector)),this.options.count=this.getCurrentCount(!0),_.isUndefined(this.options.flags.sub_clause_groups)&&(this.options.flags.sub_clause_groups=!0),_.isUndefined(this.options.flags.remove)&&(this.options.flags.remove=!0),_.isUndefined(this.options.flags.re_init_values)&&(this.options.flags.re_init_values=!1),e.template&&(this.template=e.template),this.listenTo(this,"ready",this.addSubClauseGroup)},addSubClauseGroup:function(e){e=e||!1
var r,o,n,i,s=e&&!_.isEmpty(e)
s&&e.currentTarget?t(e.currentTarget):!1;(!s||this.options.flags.sub_clause_groups)&&(s&&e.preventDefault(),r={columns:this.options.columns,flags:this.options.flags,operators:this.options.operators,parameters:this.options.parameters,type:this.options.type,shortcode:this.options.shortcode},o=new conductor_query_builder.Backbone.Models.Query_Builder_Sub_Clause_Group(r),a.add(o),conductor_query_builder.Backbone.instances.models.sub_clauses.push(o),n=_.clone(o.attributes),n.model=o,i=new conductor_query_builder.Backbone.Views.Query_Builder_Sub_Clause_Group(n),conductor_query_builder.Backbone.instances.views.sub_clauses.push(i),o.setID(i),this.views.add(i.el_selector,i),this.options.sub_clause_el_selector&&this.options.sub_clause_el_selector===i.el_selector||(this.options.sub_clause_el_selector=i.el_selector))},removeSubClauseGroup:function(e,t){e.preventDefault(),this.options.flags.sub_clause_groups&&!t.options["default"]&&(t.remove(),i.previewQuery())},render:function(t){return t=t||!1,this.options.count=t?this.options.count-1:this.options.count,t&&this.model.setID(this),e.Backbone.View.prototype.render.apply(this,arguments),this},removeClauseGroup:function(e,t){t=t||!1
var r=e&&!_.isEmpty(e);(this.options.flags.remove||t)&&(r&&e.preventDefault(),this.remove(t),i.previewQuery())},remove:function(t){t=t||!1
var r,o,n,i,s=conductor_query_builder.Backbone.instances.views.clauses,c=conductor_query_builder.Backbone.instances.views.clause_action_buttons,a=this.model.get("type"),l=this.options.count
if(this.options.flags.remove||t)return this.options.flags.removing||(this.options.flags.removing=!0),i=this.views.all(),i&&_.each(i,function(e){var t
"query-builder-actions"===e.options.type&&(t=c.map(function(e){return e.cid}).indexOf(e.cid),-1!==t&&c.splice(t,1))}),u.remove(this.model),r=e.Backbone.View.prototype.remove.apply(this,arguments),o=s.map(function(e){return e.cid}).indexOf(this.cid),-1!==o&&s.splice(o,1),-1!==l&&conductor_query_builder.meta[a][l]&&conductor_query_builder.meta[a].splice(l,1),n=s.filter(function(e){return e.options.type===a}),n.length&&_.each(n,function(e){!e.options.flags.removing&&e.options.count>l&&(e.render(!0),e.options.flags.re_rendering=!0,e.options.sub_clause_el_selector&&_.each(e.views.get(e.options.sub_clause_el_selector),function(e){e.render(!0)}),e.options.flags.re_rendering=!1)}),r},select2Change:function(e,r){var o,n,i,s=t(e.currentTarget),c=r.$select2.filter('[data-type="parameters"]'),u=c.find("option"),a=u.filter(":selected"),l=a.data("parameter"),d=a.data("field"),p=r.$select2.filter('[data-type="operators"]'),_=p.find("option"),b=p.val(),h=r.$select2.filter('[data-type="values"]'),f=h.find("option"),g=h.val(),y=s.val(),m=s.data("type"),v=s.data("select-type"),q=this.model.get("columns")
r.options.type,r.getMeta(),r.getConfig()
switch(m){case"parameters":if(this.options.flags.re_init_values=!1,o=this.getParameterData(y,l,d,v),n=this.getOperators(o),!(n&&n.length&&p.length&&y))return
this.updateOperatorsSelect(p,_,b,n),p.prop("disabled")&&p.prop("disabled",!1),r.initializeSelect2(["operators"]),i=this.getValues(y,v,a),q&&q.values&&i&&(this.options.flags.re_init_values=this.updateValuesSelect(h,f,g,i),r.initializeSelect2(["values"]))
break
case"operators":q&&q.values&&(h.prop("disabled")&&conductor_query_builder.operators[y]&&("string"==typeof conductor_query_builder.operators[y]||conductor_query_builder.operators[y].type&&"bool"!==conductor_query_builder.operators[y].type)?h.prop("disabled",!1):!h.prop("disabled")&&conductor_query_builder.operators[y]&&"string"!=typeof conductor_query_builder.operators[y]&&conductor_query_builder.operators[y].type&&"bool"===conductor_query_builder.operators[y].type&&(h.val(null).trigger("change"),h.prop("disabled",!0)))}},getCurrentCount:function(e){e=e||!1
var t
return t=u.where({type:this.options.type}).length,t=e&&0!==t?t-1:t},getFromSubClauseParameters:function(e,t,r,o,n){var i=!1
if(e&&t)return _.find(e,function(e,r){return e.clauses&&t.parameters&&(_.isArray(t.parameters)&&-1!==t.parameters.indexOf(r)||t.parameters===r)&&_.find(e.clauses,function(e,t){return t===n&&e.columns&&e.columns.parameters?(i=e.columns.parameters,!0):!1}),!1}),i},getParameterData:function(e,t,r,o){var n,i=e&&"string"==typeof e&&conductor_query_builder.parameters[e]?conductor_query_builder.parameters[e]:!1,s=void 0!==conductor_query_builder.parameters[o]
return(!i||s||!i.operators&&t&&o&&(conductor_query_builder.parameters[t]||conductor_query_builder.parameters[o]))&&(i=!i&&conductor_query_builder.parameters[t]?conductor_query_builder.parameters[t]:i,(!i||s||!i.operators&&t!==o&&conductor_query_builder.parameters[o])&&(n=conductor_query_builder.parameters[o]),n&&_.isObject(n)&&!n.operators&&n.fields&&n.fields[r]&&(i=n.fields[r])),i},getParameters:function(e){return _.isObject(e)?_.keys(e):[e]},getOperators:function(e){var t
return t=_.isObject(e)&&e.operators?e.operators:[e],t=_.isObject(t)?_.values(t):t},getValues:function(e,t,r){var o,n="string"==typeof e?conductor_query_builder.values[e]:!1,i=r&&r.length&&r.data("values")?JSON.parse(JSON.stringify(r.data("values"))):!1
return!n&&i&&(n=i),!n&&t&&conductor_query_builder.values[t]&&(n=conductor_query_builder.values[t],n&&_.isObject(n)&&(n=n.hasOwnProperty(e)?n[e]:[])),conductor_query_builder.values.all&&conductor_query_builder.values.all.length&&(n=n.concat(conductor_query_builder.values.all)),o=conductor_query_builder.values[t]&&conductor_query_builder.values[t].all,o&&o.length&&(n=n.concat(o)),n},updateParametersSelect:function(e,r,o,n,i){i=i||!1,n=n?n:[]
var s=o&&"string"==typeof o&&n.length&&-1===n.indexOf(o),c=o&&"string"==typeof o&&s,u=[],a=this.options.type,l=(conductor_query_builder.clauses[a]&&conductor_query_builder.clauses[a].parameters?conductor_query_builder.clauses[a].parameters:!1,conductor_query_builder.Backbone.instances.views.sub_clauses),d=l.map(function(e){return e.options.type}).indexOf("from"),p=-1!==d?l[d]:!1
p&&p.getMeta(),conductor_query_builder.clauses.from&&conductor_query_builder.clauses.from.parameters?conductor_query_builder.clauses.from.parameters:!1
o&&_.isArray(o)&&!c&&(_.each(o,function(e){n.length&&-1===n.indexOf(e)&&u.push(e)}),u.length===o.length&&(c=!0)),o&&c&&e.val(""),r.each(function(){var e=t(this),r=(e.prop("multiple"),e.val()),o=n.length&&-1===n.indexOf(r)
e.prop("disabled",o)}),o&&c&&(e.val(r.not(":disabled").first().val()),i||e.trigger("change"))},updateOperatorsSelect:function(e,r,o,n,i){i=i||!1,r.each(function(){var e=t(this),r=(e.prop("multiple"),e.val())
e.prop("disabled",-1===n.indexOf(r))}),o&&r.filter('[value="'+o+'"]').prop("disabled")&&(e.val(r.not(":disabled").first().val()),i||e.trigger("change"))},updateValuesSelect:function(e,r,o,n,i){i=i||!1
var s=e.val(),c=!1
return _.each(n,function(t,o){var n,i,s,u
o=_.isObject(t)?o:t,o=_.isObject(t)&&t.hasOwnProperty("value")?t.value:o,i=r.filter('[value="'+o+'"]'),s=i.length?i.text():"",i.length?(u=_.isObject(t)&&t.hasOwnProperty("label")?t.label:o,s!==u&&(i.text(u),c||(c=!0))):(n='<option value="'+o+'">',n+=_.isObject(t)&&t.hasOwnProperty("label")?t.label:o,n+="</option>",e.append(n))}),r.each(function(){var e,r=t(this),i=r.val()
e=_.findIndex(n,function(e){return"string"==typeof e?e===i:e.value===i}),-1===e&&(r.remove(),o&&("string"==typeof o&&i===o||"string"!=typeof o&&o.length&&-1!==o.indexOf(i))&&("string"==typeof o?o="":o.splice(o.indexOf(i),1)))}),(!s&&o||o&&("string"==typeof s&&"string"==typeof o&&s!==o||"string"!=typeof o&&o.length&&!_.isEqual(s,o)))&&(e.val(o),i||e.trigger("change")),c}}),conductor_query_builder.Backbone.Views.Query_Builder_Sub_Clause_Group=e.Backbone.View.extend({className:"conductor-qb-meta-box-query-builder-sub-clause-group-inner",el_selector:"",el_selector_prefix:".conductor-qb-meta-box-query-builder-",el_selector_suffix:"-sub-clause-groups",select2_selector:".conductor-qb-select2",$select2:!1,shortcode_select2_re_init:!1,values:{},template:e.template("conductor-qb-meta-box-query-builder-sub-clause-group"),events:{"click .conductor-qb-remove-action-button":"removeSubClauseGroup","change .conductor-qb-select2":"select2Change","select2:select .conductor-qb-select2":"select2SelectUnselect","select2:unselect .conductor-qb-select2":"select2SelectUnselect","select2:close .conductor-qb-select2":function(e){var r=t(e.currentTarget)
this.select2Close(e),this.updateSelect2Options(r)},"keypress .select2-search__field":function(e){var r=t(e.currentTarget),o=r.parents(".select2-container").prev(".conductor-qb-select2")
this.updateSelect2Options(o)},"keyup .select2-search__field":function(e){var r=t(e.currentTarget),o=r.parents(".select2-container").prev(".conductor-qb-select2")
this.updateSelect2Options(o)},"change .select2-search__field":function(e){var r=t(e.currentTarget),o=r.parents(".select2-container").prev(".conductor-qb-select2")
this.updateSelect2Options(o)},"input .select2-search__field":function(e){var r=t(e.currentTarget),o=r.parents(".select2-container").prev(".conductor-qb-select2")
this.updateSelect2Options(o)},"select2:opening .conductor-qb-select2":function(e){var r=this,o=t(e.currentTarget)
r.updateSelect2Options(o)},"select2:open .conductor-qb-select2":function(e){var r=this,o=t(e.currentTarget)
r.updateSelect2Options(o),setTimeout(function(){r.updateSelect2Options(o)},1)},"select2:closing .conductor-qb-select2":function(e){var r=this,o=t(e.currentTarget)
o.data("select2").trigger("query",{}),r.updateSelect2Options(o),setTimeout(function(){r.updateSelect2Options(o)},1)}},initialize:function(e){_.bindAll(this,"render","removeSubClauseGroup","select2Change","select2SelectUnselect","select2Close","getMeta","setMetaValue","getConfig","setConfig","getCurrentCount"),e.flags||(e.flags={}),e.type&&(this.el_selector=this.el_selector_prefix+e.type+this.el_selector_suffix,t(this.el_selector).length||(this.el_selector=this.el_selector_prefix+e.type.replace("_","-")+this.el_selector_suffix)),this.options.count=this.getCurrentCount(!0),this.options.count=-1!==this.options.count?this.options.count:0,this.options.parent||(this.options.parent={}),this.options.parent.count=this.views.parent&&this.views.parent.options.hasOwnProperty("count")&&-1!==this.views.parent.options.count?this.views.parent.options.count:-1,this.options.parent.limit=this.views.parent&&this.views.parent.options.hasOwnProperty("limit")&&-1!==this.views.parent.options.limit?this.views.parent.options.limit:-1,this.options.flags["default"]=0===this.options.count,e.template&&(this.template=e.template),this.listenToOnce(this,"ready",this.initializeConfigs),this.listenToOnce(this,"ready",this.initializeSelect2),this.listenToOnce(this,"ready",this.maybeEnableActionButtons),this.listenToOnce(this,"ready",this.maybeSetModelID),this.listenToOnce(this,"ready",this.maybeSetModelParentData)},initializeConfigs:function(){var e=this,r=this.$el.find(this.select2_selector)
r.each(function(){var r=t(this),o=r.find("option:selected:first"),n=o.val(),i=o.data("config")
i&&e.setConfig(n,i)})},initializeSelect2:function(e,r){e=e||[],r=r===!1?r:!r
var o,n,i,s,c,u,a,l=this,d=this.$el.find(this.select2_selector),p=d.filter('[data-type="parameters"]'),b=p.find("option"),h=d.filter('[data-type="operators"]'),f=h.find("option"),g=d.filter('[data-type="values"]'),y=g.find("option"),m=this.views.parent.model.get("columns"),v=conductor_query_builder.Backbone.instances.views.sub_clauses,q=v.map(function(e){return e.options.type}).indexOf("from"),w=-1!==q?v[q]:!1,B=w&&w.getMeta(),k=(w&&w.options.type,w&&w.getConfig())
this.$select2=d,d.each(function(){var d,v=t(this),q={},w=v.data("select2"),C=[],x=[],S=v.data("select-type"),O=v.data("type"),T=v.val(),A=l.getMeta(),V=v.prop("multiple"),$=v.data("selected-options")
if(!e.length||-1!==e.indexOf(O)){if(l.options.columns[O]&&l.options.columns[O].select2&&l.options.columns[O].select2.tags){if(q.tags=!0,!w)switch(T=A.values,n=A.parameters&&"string"==typeof A.parameters&&conductor_query_builder.clauses[S]&&conductor_query_builder.clauses[S].parameters?conductor_query_builder.clauses[S].parameters:!1,n=n&&"string"==typeof A.parameters&&n[A.parameters]&&n[A.parameters].field?n[A.parameters].field:"string"==typeof A.parameters?A.parameters:!1,A.parameters&&!n&&(o=A.parameters.slice(0),n=o&&conductor_query_builder.clauses[S]&&conductor_query_builder.clauses[S].parameters&&conductor_query_builder.clauses[S].parameters?conductor_query_builder.clauses[S].parameters:!1,n=n&&n[o]&&n[o].field?n[o].field:!1),O){case"values":i=l.views.parent.getParameterData(T,o?o:A.parameters,n,S),s=l.views.parent.getOperators(i),s&&s.length&&h.length&&(l.views.parent.updateOperatorsSelect(h,f,A.operators&&"string"==typeof A.operators?A.operators:A.operators.slice(0),s,!0),c=l.views.parent.getValues(o?o:A.parameters,S,b.filter(":selected")),m&&m.values&&c&&(l.views.parent.updateValuesSelect(g,y,T,c,!0),y=g.find("option")),T&&T.length&&!_.isEqual(T,c)&&_.each(T,function(e){y.filter('[value="'+e+'"]').length||(q.hasOwnProperty("data")||(q.data=[]),q.data.push(e))}))}q.tokenSeparators=l.options.columns[O].select2.tags}switch(l.options.shortcode&&(q.dropdownParent=t("#TB_ajaxContent")),conductor_query_builder.select2.language&&(q.language=conductor_query_builder.select2.language),conductor_query_builder.select2.dir&&(q.dir=conductor_query_builder.select2.dir),w&&w.isOpen()&&v.select2("close"),v.conductor_qb_select2(q),O){case"parameters":h.prop("disabled")&&A.parameters&&h.prop("disabled",!1),n=A.parameters&&"string"==typeof A.parameters&&conductor_query_builder.clauses[S]&&conductor_query_builder.clauses[S].parameters?conductor_query_builder.clauses[S].parameters:!1,n=n&&"string"==typeof A.parameters&&n[A.parameters]&&n[A.parameters].field?n[A.parameters].field:"string"==typeof A.parameters?A.parameters:!1,A.parameters&&!n&&(o=A.parameters.slice(0),n=o&&conductor_query_builder.clauses[S]&&conductor_query_builder.clauses[S].parameters&&conductor_query_builder.clauses[S].parameters?conductor_query_builder.clauses[S].parameters:!1,n=n&&n[o]&&n[o].field?n[o].field:!1),u=l.views.parent.getFromSubClauseParameters(k,B,o?o:A.parameters,n,S),a=u?u:conductor_query_builder.clauses[S]&&conductor_query_builder.clauses[S].parameters?l.views.parent.getParameters(conductor_query_builder.clauses[S].parameters):!1,a&&(A=l.getMeta(),A.parameters&&(o=A.parameters.slice(0),n=o&&conductor_query_builder.clauses[S]&&conductor_query_builder.clauses[S].parameters&&conductor_query_builder.clauses[S].parameters?conductor_query_builder.clauses[S].parameters:!1,n=n&&n[o]&&n[o].field?n[o].field:!1)),l.views.parent.updateParametersSelect(p,b,T,a,r),T=v.val(),i=i?i:l.views.parent.getParameterData(T,o?o:A.parameters,n,S),s=!s&&i?l.views.parent.getOperators(i):s,s&&s.length&&h.length&&l.views.parent.updateOperatorsSelect(h,f,A.operators?A.operators&&"string"==typeof A.operators?A.operators:A.operators.slice(0):"",s,r)
break
case"operators":A=l.getMeta(),i=i?i:l.views.parent.getParameterData(A.parameters,o?o:A.parameters,n,S),s=!s&&i?l.views.parent.getOperators(i):s,s&&s.length&&h.length&&l.views.parent.updateOperatorsSelect(h,f,A.operators?A.operators&&"string"==typeof A.operators?A.operators:A.operators.slice(0):"",s,r),m&&m.values&&(g.prop("disabled")&&conductor_query_builder.operators[T]&&("string"==typeof conductor_query_builder.operators[T]||conductor_query_builder.operators[T].type&&"bool"!==conductor_query_builder.operators[T].type)?g.prop("disabled",!1):!g.prop("disabled")&&conductor_query_builder.operators[T]&&"string"!=typeof conductor_query_builder.operators[T]&&conductor_query_builder.operators[T].type&&"bool"===conductor_query_builder.operators[T].type&&(g.val(null).trigger("change"),g.prop("disabled",!0)))
break
case"values":A.values&&(T=v.val(),_.isEqual(T,A.values)||(v.val(A.values).trigger("change"),T=v.val())),V&&$&&l.updateSelect2Options(v)}v.conductor_qb_select2(q),w=v.data("select2"),d=w.$element.attr("class").split(/\s+/),d=d.map(function(e){return-1===e.indexOf("select2")?e:""}).filter(function(e){return e}),_.each(d,function(e){C.push(e+"-select2"),C.push(e+"-select2-container"),x.push(e+"-select2"),x.push(e+"-select2-results")}),C=C.join(" "),x=x.join(" "),w.$container.addClass(C),w.$results.addClass(x),l.setMetaValue(O,T)}})},maybeEnableActionButtons:function(){var e=this.$el.find(this.select2_selector)
e.each(function(){var e=t(this),r=e.val(),o=e.data("toggle-action-buttons")
return o&&(r||_.isArray(r)&&r.length)?(c.trigger("conductor-qb-enable-action-buttons"),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.trigger("conductor-qb-enable-action-buttons")}),!1):void 0})},maybeSetModelID:function(e){e=e||!1
var t=this.model.get("id"),r=this.model.getIDFromView(this);(!t||r&&t!==r||e)&&this.model.setID(this,r)},maybeSetModelParentData:function(e){e=e||!1
var t=this.model.get("parent")
this.views.parent&&this.views.parent.model&&(-1!==t.count||-1===this.options.parent.count)&&(t.id!==this.model.get("id")||t.count!==this.views.parent.options.count||t.limit!==this.views.parent.model.get("limit")||e)&&this.model.setParentData(this)},setupMetaValues:function(){var e=this.model.get("parent"),t=-1!==e.count?e.count:-1,r=this.options.count,o=this.getMeta()
this.views.parent&&this.views.parent.options.meta&&-1!==t&&-1!==r&&(this.views.parent.options.meta[t]&&this.views.parent.options.meta[t][r]?(o=_.clone(conductor_query_builder.Backbone.defaults.meta),_.each(this.views.parent.options.meta[t][r],function(e,t){o[t]=e}),this.model.set("meta",o),this.options.meta=o):(o=_.clone(conductor_query_builder.Backbone.defaults.meta),this.model.set("meta",o),this.options.meta=o))},destroySelect2:function(){var e=this.$el.find(this.select2_selector)
e.each(function(){var r=t(this),o=r.data("select2")
o&&e.conductor_qb_select2("destroy")})},removeSubClauseGroup:function(e){e.preventDefault(),this.options["default"]||this.views.parent.removeSubClauseGroup(e,this)},render:function(t){return t=t||this.views.parent.options.flags.re_rendering||!1,this.maybeSetModelID(t),this.maybeSetModelParentData(t),this.options.count=t&&!this.views.parent.options.flags.re_rendering?this.options.count-1:this.getCurrentCount(!0),this.options.count=-1!==this.options.count?this.options.count:0,this.options.parent.count=this.views.parent&&this.views.parent.options.hasOwnProperty("count")?this.views.parent.options.count:-1,this.options.parent.limit=this.views.parent&&this.views.parent.options.hasOwnProperty("limit")?this.views.parent.options.limit:-1,this.options.parent_id=this.model.get("parent_id"),this.options.flags["default"]=0===this.options.count,this.views.parent&&_.isUndefined(this.views.parent.options.flags.sub_clause_groups)&&(this.options.flags.sub_clause_groups=!0),this.setupMetaValues(),e.Backbone.View.prototype.render.apply(this,arguments),t&&(this.listenToOnce(this,"ready",this.initializeSelect2),this.listenToOnce(this,"ready",this.maybeEnableActionButtons),this.trigger("ready")),this},remove:function(){var t,r,o=conductor_query_builder.Backbone.instances.views.sub_clauses,n=this.model.get("type"),i=this.views.parent,s=this.model.get("parent"),c=-1!==s.count?s.count:-1,u=this.options.count,l=this.el_selector
return this.destroySelect2(),a.remove(this.model),t=e.Backbone.View.prototype.remove.apply(this,arguments),r=o.map(function(e){return e.cid}).indexOf(this.cid),-1!==r&&o.splice(r,1),-1!==c&&-1!==u&&conductor_query_builder.meta[n][c]&&conductor_query_builder.meta[n][c]&&conductor_query_builder.meta[n][c][u]&&conductor_query_builder.meta[n][c].splice(u,1),i.options.flags.removing||_.each(i.views.get(l),function(e){-1!==e.options.count&&(e.options.parent.count!==c&&e.options.parent.count>c||e.options.count>u)&&e.render(!0)}),t},select2Change:function(e){var r=t(e.currentTarget),o=(r.data("select2"),r.val()),n=r.data("type")
this.setMetaValue(n,o),this.views.parent.select2Change(e,this)},select2SelectUnselect:function(e){var r,o,n=t(e.currentTarget),i=n.parents(".widget"),a=n.val(),l=n.find("option:selected"),d=-1,p=n.prop("multiple"),b=n.data("selected-options")||[],h=n.data("type"),f=e.params.data.id,g=n.find('option[value="'+f+'"]'),y=g.data("config"),m={},v=this.options.columns&&this.options.columns[h]&&this.options.columns[h].select2,q=n.data("toggle-action-buttons"),w=this.options.type,B=conductor_query_builder.Backbone.instances.views.sub_clauses,k=this
if(_.each(l,function(e){var r=t(e),o=r.data("config"),n=r.attr("value")
o&&(m[n]=o.columns&&o.columns[h]&&o.columns[h].select2)}),y&&(m[f]=y.columns&&y.columns[h]&&y.columns[h].select2,this.setConfig(f,y)),m[f]?_.each(m[f],function(r,o){var i=!1
switch(o){case"multiple":p&&!r?(l.each(function(){var e=t(this)
e[0]!==g[0]&&(e.prop("selected",!1),i||(i=!0))}),n.prop("multiple",r),i&&n.trigger("change")):!p&&r&&n.prop("multiple",r),"select2:unselect"===e.type&&(g.prop("selected",!1),k.setConfig(f,!1),v&&void 0!==v[o]&&r!==v[o]&&n.prop("multiple",v[o]),r||(n.val([]),a=n.val()),n.trigger("change"))}}):v&&_.each(v,function(e,t){switch(t){case"multiple":p&&!e?n.prop("multiple",e):!p&&e&&n.prop("multiple",e)}}),q&&(a||_.isArray(a)&&a.length?(c.trigger("conductor-qb-enable-action-buttons"),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.trigger("conductor-qb-enable-action-buttons")})):(c.trigger("conductor-qb-disable-action-buttons"),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.trigger("conductor-qb-disable-action-buttons")}))),"from"===w&&(r=s.$el.find(".conductor-select-content-type"),o=p&&a?a[a.length-1]:a,o?r.val(o).trigger("change"):r.val(r.find("option:first").val()).trigger("change"),"select2:select"===e.type&&y&&"select2:select"===e.type&&(_.each(y,function(e){_.each(e,function(e,t){e.disabled&&u.length&&u.each(function(e){var r
e&&e.get("type")===t&&(r=s.views.get(e.get("el_selector")),r.length&&_.each(r,function(t){t.model.get("id")===e.get("id")&&t.removeClauseGroup(!1,!0)}))})})}),B=conductor_query_builder.Backbone.instances.views.sub_clauses),"parameters"===h&&_.each(B,function(e){e.options.type!==w&&e.initializeSelect2(["parameters","operators"],!1)})),"values"===h&&p){switch(e.type){case"select2:select":b.push(f)
break
case"select2:unselect":d=b.indexOf(f),-1!==d&&b.splice(d,1)}n.data("selected",b).attr("selected-options",JSON.stringify(b)),this.updateSelect2Options(n)}i.trigger("conductor-query-builder:select2-select-unselect",[n,e,w,h,a,f,p,m,k]),k.trigger("conductor-query-builder:select2-select-unselect",[n,e,a,f,p,w,m,k])},select2Close:function(e){var r=t(e.currentTarget)
this.options.shortcode&&!this.shortcode_select2_re_init&&(this.shortcode_select2_re_init=!0,function(e,r){setTimeout(function(){var o=r.$el.find(r.select2_selector).not(e),n=o.filter(function(){var e=t(this),r=e.data("select2"),o=r.$container
return o.hasClass("select2-container--open")})
r.initializeSelect2(r.views.parent.options.flags.re_init_values?[]:["parameters","operators"]),n.length&&n.each(function(){t(this).select2("open")}),r.shortcode_select2_re_init=!1},1)}(r,this))},getMeta:function(){return this.model.get("meta")},setMetaValue:function(e,t){var r=this.getMeta(),o=this.model.get("type"),n=this.model.get("parent"),i=-1!==n.count?n.count:-1,s=this.options.count
r[e]=t,this.model.set("meta",r),this.options.meta=r,-1!==i&&-1!==s&&(conductor_query_builder.meta[o][i]||(conductor_query_builder.meta[o][i]=[]),conductor_query_builder.meta[o][i][s]||(conductor_query_builder.meta[o][i][s]=_.clone(conductor_query_builder.Backbone.defaults.meta)),conductor_query_builder.meta[o][i][s][e]&&_.isEqual(conductor_query_builder.meta[o][i][s][e],t)||(conductor_query_builder.meta[o][i][s][e]=t))},getConfig:function(){return this.model.get("config")},setConfig:function(e,t){var r=this.getConfig()
r[e]=t,this.model.set("config",r),this.options.config=r},getCurrentCount:function(e){e=e||!1
var t
return this.model.get("parent_id")?(t=a.where({parent_id:this.model.get("parent_id")}).length,t=e&&0!==t?t-1:t):-1},updateSelect2Options:function(e){var r=e.data("select2"),o=r.$container,n=o.find(".select2-selection__choice"),i=o.find(".select2-search"),s=e.data("selected-options")
s&&s.length&&_.each(s,function(e){i.before(n.filter(function(){return t(this).data("data").id===""+e}))})}}),conductor_query_builder.Backbone.Models.Shortcode=Backbone.Model.extend({defaults:{create_title:"",insert_query:"",insert_title:""},id_prefix:"conductor-qb-",initialize:function(){_.bindAll(this,"setID","removeFromInstances"),this.setID(),this.listenTo(this,"remove",this.removeFromInstances),this.listenTo(this,"remove",this.stopListening)},setID:function(){this.set("id",this.id_prefix+"shortcode")},removeFromInstances:function(){var e,t=conductor_query_builder.Backbone.instances.models.shortcode,r=this
e=t.map(function(e){return e.get("id")}).indexOf(r.get("id")),-1!==e&&t.splice(e,1)},getShortcode:function(e){e=e||{id:this.get("insert_query")}
var t=""
return e.id?(t+="["+conductor_query_builder.shortcode,_.each(e,function(e,r){e&&(t+=" "+r+'="'+e+'"')}),t+="]"):t}}),conductor_query_builder.Backbone.Collections.Shortcode=Backbone.Collection.extend({}),conductor_query_builder.Backbone.Views.Shortcode=e.Backbone.View.extend({el:"#conductor-qb-shortcode-wrapper",has_user_changed_feature_type:!1,feature_type_value:"",events:{"change .conductor-select-feature-type":"setHasUserChangedFeatureTypeFlag","click .conductor-qb-shortcode-tabs .nav-tab":"switchShortcodeActionButton","click .conductor-qb-shortcode-action-button":"shortcodeActionButton","change #conductor-qb-shortcode-insert-query":"setInsertQuery","keyup #conductor-qb-shortcode-insert-title":"setInsertTitle","change #conductor-qb-shortcode-insert-title":"setInsertTitle","keyup #conductor-qb-shortcode-create-title":"setCreateTitle","change #conductor-qb-shortcode-create-title":"setCreateTitle"},initialize:function(e){_.bindAll(this,"render","setHasUserChangedFeatureTypeFlag","switchShortcodeActionButton","shortcodeActionButton","setInsertQuery","setCreateTitle")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this},reset:function(){this.$el.find("#conductor-qb-shortcode-insert-title").val("").change(),this.$el.find("#conductor-qb-shortcode-insert-query").val("").change(),this.$el.find("#conductor-qb-shortcode-create-title").val("").change()},setHasUserChangedFeatureTypeFlag:function(e){this.feature_type_value=t(e.currentTarget).val(),this.has_user_changed_feature_type||(this.has_user_changed_feature_type=!0)},switchShortcodeActionButton:function(e){var r=t(e.currentTarget),o=r.data("shortcode-action")
b.options.button_type=o,b.options.label=conductor_query_builder.l10n.shortcode[o],b.render(),this.maybeToggleActionButton(o)},maybeToggleActionButton:function(e){var t,r=b.$el.find(".conductor-qb-shortcode-action-button")
switch(e=e||r.data("type")){case"insert":t=this.model.get("insert_query"),t||r.prop("disabled")?t&&r.prop("disabled")&&b.enableActionButton():b.disableActionButton()
break
case"create":t=this.model.get("create_title"),t||r.prop("disabled")?t&&r.prop("disabled")&&b.enableActionButton():b.disableActionButton()}},shortcodeActionButton:function(r){var o,n=t(r.currentTarget),i=n.data("type")
switch(r.preventDefault(),b.$el.find(".conductor-qb-loading").addClass("is-active conductor-qb-spinner-is-active"),i){case"insert":o=this.model.getShortcode({id:this.model.get("insert_query"),title:this.model.get("insert_title")}),o?send_to_editor(o):tb_remove(),b.$el.find(".conductor-qb-loading").removeClass("is-active conductor-qb-spinner-is-active")
break
case"create":e.ajax.post(conductor_query_builder.ajax.shortcode.action,this.ajax.setupAJAXData(conductor_query_builder.ajax.shortcode.nonce,conductor_query_builder.ajax.shortcode.action)).done(this.ajax.success).fail(this.ajax.fail),b.disableActionButton()}},setInsertQuery:function(e){var r=t(e.currentTarget),o=r.val()
this.model.set("insert_query",o),this.maybeToggleActionButton()},setInsertTitle:function(e){var r=t(e.currentTarget),o=r.val()
this.model.set("insert_title",o)},setCreateTitle:function(e){var r=t(e.currentTarget),o=r.val()
this.model.set("create_title",o),this.maybeToggleActionButton()},ajax:{data:{conductor_query_builder:1},setupAJAXData:function(e,t){return i.ajax.setupAJAXData(-1,e,t,p.$el.find(".conductor-qb-shortcode-create-form"))},success:function(e){var t=p.model.getShortcode({id:e.ID,title:e.title})
t?(send_to_editor(t),conductor_query_builder.queries.push({ID:e.ID,post_title:e.title}),h.render()):tb_remove(),b.$el.find(".conductor-qb-loading").removeClass("is-active conductor-qb-spinner-is-active")},fail:function(e){b.enableActionButton()}},isSimpleQueryArgsEmpty:function(){var e=this.$el.find(".widget"),r=e.find(".conductor-section-general"),o=!0
return"simple"!==window.getUserSetting(conductor_query_builder.user.settings["query-builder"].mode.name)?o:(r.find(":input").each(function(){var e,r=t(this),n=r.val()
if(o)switch(this.nodeName.toLowerCase()){case"input":n!==this.defaultValue&&(o=!1)
break
case"select":e=r.find('option[value="'+n+'"]'),r.find('option[value="'+n+'"]')[0].defaultSelected||0===e.index()||(o=!1)}}),o)}}),conductor_query_builder.Backbone.Views.Shortcode_Actions=e.Backbone.View.extend({id:"conductor-qb-shortcode-actions-inner",el_selector:"#conductor-qb-shortcode-actions",template:e.template("conductor-qb-shortcode-query-builder-actions"),initialize:function(e){_.bindAll(this,"render")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this},disableActionButton:function(){var e=this.$el.find(".conductor-qb-shortcode-action-button")
e.prop("disabled",!0)},enableActionButton:function(){var e=this.$el.find(".conductor-qb-shortcode-action-button")
e.prop("disabled",!1)}}),conductor_query_builder.Backbone.Views.Shortcode_Insert=e.Backbone.View.extend({id:"conductor-qb-shortcode-insert-inner",el_selector:"#conductor-qb-shortcode-insert",select2_selector:".conductor-qb-select2",template:e.template("conductor-qb-shortcode-query-builder-insert"),initialize:function(e){_.bindAll(this,"render")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this.initializeSelect2(),this},reset:function(){this.$el.find("#conductor-qb-shortcode-insert-title").val("").change(),this.$el.find("#conductor-qb-shortcode-insert-query").val("").change(),this.$el.find("#conductor-qb-shortcode-create-title").val("").change(),this.destroySelect2()},initializeSelect2:function(){var e=this
setTimeout(function(){e.$el.find(e.select2_selector).conductor_qb_select2({dropdownParent:t("#TB_ajaxContent")})},1)},destroySelect2:function(){var e=this.$el.find(this.select2_selector)
e.each(function(){var r=t(this),o=r.data("select2")
o&&e.conductor_qb_select2("destroy")})}}),conductor_query_builder.Backbone.Views.Shortcode_Create_Title=e.Backbone.View.extend({id:"conductor-qb-shortcode-create-title-inner",el_selector:"#conductor-qb-shortcode-create-title-content",template:e.template("conductor-qb-shortcode-query-builder-create-title"),initialize:function(e){_.bindAll(this,"render")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this}}),t(function(){var e,i=t("#post"),c=t(".conductor-qb-tabs a"),u=t(".conductor-qb-add-shortcode")
o=t(document),r=t("body"),n=t("#conductor-query-builder-preview"),c.on("click.conductor-qb",function(e){var r=t(this),o=r.siblings(),n=r.parents(".conductor-qb-tabs-wrapper"),i=n.next(".conductor-qb-tab-content-wrapper").find(".conductor-qb-tab"),s=r.attr("href")
i=i.filter('[data-type="'+r.data("type")+'"]'),e.preventDefault(),o.removeClass("nav-tab-active"),i.removeClass("active"),r.addClass("nav-tab-active"),t(s).addClass("active")}),conductor_query_builder.flags.is_query_builder_post_type&&conductor_query_builder.fn.query_builder.init(),u.on("click.conductor-qb",function(e){r.addClass("conductor-shortcode-ui-visible"),p?(conductor_query_builder.fn.shortcode.reset(),h.render(),conductor_query_builder.fn.query_builder.reset(),s.initialize(),s.trigger("conductor-qb-shortcode-reset"),s.$el.trigger("conductor-qb-shortcode-reset")):(r.addClass("conductor-shortcode-ui-initialized"),conductor_query_builder.fn.shortcode.init(),conductor_query_builder.fn.query_builder.init(!0),s.trigger("conductor-qb-shortcode-init"),s.$el.trigger("conductor-qb-shortcode-init")),o.trigger("conductor-query-builder-thickbox-init",[p,s]),tb_show(conductor_query_builder.l10n.shortcode.title,"#TB_inline?inlineId=conductor-qb-shortcode-wrapper-container&width=753&height=480",!1),"advanced"===window.getUserSetting(conductor_query_builder.user.settings["query-builder"].mode.name)&&setTimeout(function(){_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.$el.find(e.action_button_selector).removeClass("hide hidden conductor-qb-hide conductor-qb-hidden")})},1)}),r.on("thickbox:removed",function(){r.hasClass("conductor-shortcode-ui-visible")&&(conductor_query_builder.fn.shortcode.reset(),conductor_query_builder.fn.query_builder.reset(),p.$el.find(".conductor-qb-tabs .nav-tab:first-child").trigger("click"),conductor_query_builder.fn.conductor.widget.reset(),o.trigger("conductor-query-builder-thickbox-removed",[p,s]),setTimeout(function(){r.removeClass("conductor-shortcode-ui-visible")},1))}),o.on("keydown.conductor-qb",".select2-search__field, .select2-search--inline",function(e){r.hasClass("conductor-shortcode-ui-visible")&&27===e.which&&e.stopImmediatePropagation()}),o.on("keydown.conductor-qb",function(e){r.hasClass("conductor-shortcode-ui-visible")&&27===e.which&&(a.isMetaEmpty()&&p.isSimpleQueryArgsEmpty()||window.confirm(conductor_query_builder.l10n.shortcode.confirm)||e.stopImmediatePropagation())}),e=new MutationObserver(function(e){r.hasClass("conductor-shortcode-ui-visible")&&_.each(e,function(e){e.addedNodes&&e.addedNodes.length&&_.each(e.addedNodes,function(e){if("TB_window"===e.id){var o=t("#TB_overlay, #TB_closeWindowButton")
o.on("click.conductor-qb",function(e){r.hasClass("conductor-shortcode-ui-visible")&&(a.isMetaEmpty()&&p.isSimpleQueryArgsEmpty()||window.confirm(conductor_query_builder.l10n.shortcode.confirm)||e.stopImmediatePropagation())}),o.each(function(){var e,r=(t(this),jQuery._data(this,"events")),o=-1
r&&r.click&&r.click.length&&(_.each(r.click,function(e,t){"conductor-qb"===e.namespace&&(o=t)}),-1!==o&&(e=r.click.splice(o,1),e.length&&r.click.splice(0,0,e[0])),jQuery._data(this,"events",r))})}})})}),e.observe(r[0],{childList:!0}),i.submit(function(e){var r=t(".conductor-qb-select2")
r.each(function(){var e=t(this),r=e.data("type"),o=e.prop("multiple"),n=e.data("selected-options")
"values"===r&&o&&n.length&&_.each(n.reverse(),function(t){var r=e.find('option[value="'+t+'"]')
r.length&&e.prepend(r)})})})})}(wp,jQuery)