/**
 * Conductor Query Builder Admin
 */

var conductor_query_builder=conductor_query_builder||{}
!function(e,t){"use strict"
var o,r,i,n,s,c,u,a,l,d,p,b
conductor_query_builder.hasOwnProperty("Backbone")||(conductor_query_builder.Backbone={Views:{},Models:{},Collections:{},instances:{models:{clauses:[],sub_clauses:[],shortcode:[]},collections:{clauses:[],sub_clauses:[],shortcode:[]},views:{clauses:[],sub_clauses:[],clause_action_buttons:[]}},defaults:{meta:{parameters:!1,operators:!1,values:!1},parent:{count:-1,id:"",limit:-1}}}),conductor_query_builder.hasOwnProperty("fn")||(conductor_query_builder.fn={query_builder:{init:function(e){e=e||!1
var o=t(".widget","#widgets-right"),u=o.find(".conductor-accordion-section")
s=new conductor_query_builder.Backbone.Collections.Query_Builder_Clause_Group,conductor_query_builder.Backbone.instances.collections.clauses=s,c=new conductor_query_builder.Backbone.Collections.Query_Builder_Sub_Clause_Group,conductor_query_builder.Backbone.instances.collections.sub_clauses=c,i=new conductor_query_builder.Backbone.Views.Query_Builder({type:"query-builder",shortcode:e}),conductor_query_builder.Backbone.instances.views.query_builder=i,n=new conductor_query_builder.Backbone.Views.Query_Builder_Actions({type:"query-builder-actions",shortcode:e}),conductor_query_builder.Backbone.instances.views.query_builder_actions=n,i.views.set(n.el_selector,n,{silent:!0}),i.render(),setTimeout(function(){u.each(function(){var e=t(this),o=e.find(".conductor-accordion-section-title"),r=e.find(".conductor-accordion-section-content")
o.length&&!e.hasClass("open")&&r.slideToggle(0)}),r=new conductor_query_builder.Backbone.Views.Query_Builder_Wrapper({type:"query-builder-wrapper",shortcode:e}),conductor_query_builder.Backbone.instances.views.query_builder_wrapper=r},1)},reset:function(){i.reset(),i.render()}},shortcode:{init:function(){a=new conductor_query_builder.Backbone.Collections.Shortcode,conductor_query_builder.Backbone.instances.collections.shortcode.push(a),u=new conductor_query_builder.Backbone.Models.Shortcode,a.add(u),conductor_query_builder.Backbone.instances.models.shortcode.push(u),l=new conductor_query_builder.Backbone.Views.Shortcode({model:u,queries:conductor_query_builder.queries,type:"shortcode"}),conductor_query_builder.Backbone.instances.views.shortcode=l,d=new conductor_query_builder.Backbone.Views.Shortcode_Actions({type:"shortcode-actions",button_type:"insert",label:conductor_query_builder.l10n.shortcode.insert}),conductor_query_builder.Backbone.instances.views.shortcode_actions=d,l.views.set(d.el_selector,d,{silent:!0}),p=new conductor_query_builder.Backbone.Views.Shortcode_Insert({queries:l.options.queries,type:"shortcode-insert"}),conductor_query_builder.Backbone.instances.views.shortcode_insert=p,l.views.set(p.el_selector,p,{silent:!0}),b=new conductor_query_builder.Backbone.Views.Shortcode_Create_Title({type:"shortcode-create-title"}),conductor_query_builder.Backbone.instances.views.shortcode_create_title=b,l.views.set(b.el_selector,b,{silent:!0}),l.render()},reset:function(){l.reset(),p.reset()}},conductor:{widget:{reset:function(){var e=!1,o=[]
setTimeout(function(){_.each(conductor_query_builder.widgets.conductor.defaults,function(r,i){if("output_features"!==i)if(e=!1,_.isObject(r))switch(i){case"output":l.$el.find(".conductor-output-data").val(JSON.stringify(r)),l.$el.find(".featured-one-select").val(""),_.each(r,function(t,r){var i
switch(e=l.$el.find('[data-id="'+t.id+'"]'),o.push(t.id),t.id){case"post_content":e.find(".conductor-widget-output-element-label-select select").val(t.value)}e.addClass("visible"),e.data("visible","true").attr("data-visible","true"),t.link&&(e.addClass("link"),e.data("link","true").attr("data-link","true")),i=e.find(".conductor-widget-output-element-label .label"),i.length?i.parent().removeClass("editing"):(i=e.find(".conductor-widget-output-element-label"),i.removeClass("editing")),i.html(t.label),e.data("label",t.label).attr("data-label",t.label),e.data("priority",r).attr("data-priority",r),l.$el.find(".conductor-widget-output-list").append(e)}),l.$el.find(".conductor-widget-output-element").each(function(){var e=t(this);-1===o.indexOf(e.data("id"))&&e.remove()})
break
default:_.each(r,function(t,o){switch(t="boolean"!=typeof t||t?t:"",i){case"flexbox":switch(o){case"columns":e=l.$el.find(':input[id$="'+i+"_"+o+'"]'),e.length&&e.val()!==t&&(e.val(t).trigger("change input"),e.next(".conductor-flexbox-columns-value").html(t))}break
default:switch(e=l.$el.find(':input[id$="'+o+'"]'),o){case"cat":t="0"}e.length&&e.val()!==t&&e.val(t).trigger("change")}})}else{switch(e=l.$el.find(':input[id$="'+i+'"]'),i){case"widget_size":e=l.$el.find(".conductor-widget-size-value:checked")}if(e.length&&(r="boolean"!=typeof r||r?r:"",e.val()!==r))switch(e.val(r).trigger("change"),i){case"widget_size":e=l.$el.find('.conductor-widget-size-value[id$="'+r+'"]').trigger("change").prop("checked",!0)}}})},1)}}}}),conductor_query_builder.Backbone.Models.Query_Builder_Clause_Group=Backbone.Model.extend({defaults:{columns:!1,el_selector:"",flags:[],operators:[],parameters:[],title:"",limit:-1,type:!1},id_prefix:"conductor-qb-",initialize:function(){_.bindAll(this,"setID","removeFromInstances"),this.listenTo(this,"remove",this.removeFromInstances),this.listenTo(this,"remove",this.stopListening)},setID:function(e){-1!==e.options.count&&this.set("id",this.getIDFromView(e))},getIDFromView:function(e){return this.id_prefix+this.get("type")+"-"+e.options.count},removeFromInstances:function(){var e,t=conductor_query_builder.Backbone.instances.models.clauses,o=this
e=t.map(function(e){return e.get("id")}).indexOf(o.get("id")),-1!==e&&t.splice(e,1)}}),conductor_query_builder.Backbone.Models.Query_Builder_Sub_Clause_Group=Backbone.Model.extend({defaults:{columns:!1,flags:[],meta:_.clone(conductor_query_builder.Backbone.defaults.meta),operators:[],parameters:[],parent_id:"",parent:_.clone(conductor_query_builder.Backbone.defaults.parent),title:"",type:!1},id_prefix:"conductor-qb-",initialize:function(){_.bindAll(this,"setID","setParentID","removeFromInstances"),this.listenTo(this,"remove",this.removeFromInstances),this.listenTo(this,"remove",this.stopListening)},setID:function(e,t){t=t||!1,e.views.parent&&e.views.parent.model&&-1!==e.options.count&&(this.setParentID(e.views.parent.model.get("id")),this.set("id",t?t:this.getIDFromView(e)))},getIDFromView:function(e){return this.id_prefix+e.views.parent.model.get("id").replace(this.id_prefix,"")+"-"+e.options.count},setParentID:function(e){var t=_.clone(this.get("parent"))
t.id=e,this.set("parent",t),this.set("parent_id",e)},setParentData:function(e){var t=_.clone(this.get("parent"))
t.count=e.views.parent.options.count,t.limit=e.views.parent.model.get("limit"),this.set("parent",t)},removeFromInstances:function(){var e,t=conductor_query_builder.Backbone.instances.models.sub_clauses,o=this
e=t.map(function(e){return e.get("id")}).indexOf(o.get("id")),-1!==e&&t.splice(e,1)}}),conductor_query_builder.Backbone.Collections.Query_Builder_Clause_Group=Backbone.Collection.extend({}),conductor_query_builder.Backbone.Collections.Query_Builder_Sub_Clause_Group=Backbone.Collection.extend({isMetaEmpty:function(){return this.every(function(e){var t=e.get("meta")
return!t.parameters&&!t.operators&&!t.values})}}),conductor_query_builder.Backbone.Views.Query_Builder_Wrapper=e.Backbone.View.extend({el:"#conductor-qb-query-builder",events:{"change :input":"previewQuery","change .conductor-widget-size-value":"maybeShowConductorWidgetColumnsSetting"},initialize:function(e){_.bindAll(this,"render","previewQuery")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this},previewQuery:_.debounce(function(){this.options.shortcode||(o.addClass(conductor_query_builder.css.classes.loading),e.ajax.post(conductor_query_builder.ajax.preview.action,this.ajax.setupAJAXData(conductor_query_builder.ID,conductor_query_builder.ajax.preview.nonce,conductor_query_builder.ajax.preview.action)).done(this.ajax.success).fail(this.ajax.fail))},300),maybeShowConductorWidgetColumnsSetting:function(e){var o=t(e.currentTarget),r=o.val(),i=conductor.widgets.conductor.displays,n=r&&i&&i[r]&&_.isObject(i[r])?i[r]:!1,s=o.parents(".widget"),c=s.find(".conductor-columns"),u=window.getUserSetting(conductor_query_builder.user.settings["query-builder"].mode.name)
u&&"advanced"===u&&setTimeout(function(){conductor.widgets.conductor.renderElement(c,s,o,{display:{supports:"columns",config:n?n:{}},feature_type:"true"})},1)},ajax:{setupAJAXData:function(e,o,i){var n=t.extend({ID:e,nonce:o,nonce_action:i},this.data),s=r.$el.find(":input"),c=s.serializeArray()
return _.each(c,function(e){n[e.name]?(_.isArray(n[e.name])||(n[e.name]=[n[e.name]]),n[e.name].push(e.value)):n[e.name]=e.value}),n},success:function(e){e.preview?o.removeClass(conductor_query_builder.css.classes.loading).html(e.preview):o.removeClass(conductor_query_builder.css.classes.loading)},fail:function(){o.removeClass(conductor_query_builder.css.classes.loading).html(conductor_query_builder.l10n.ajax.fail.preview)}}}),conductor_query_builder.Backbone.Views.Query_Builder=e.Backbone.View.extend({el:"#conductor-qb-meta-box-query-builder-tab-content",query_builder_mode_attr:"data-query-builder-mode",initialize:function(e){_.bindAll(this,"render")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this.renderClauseGroups(),this},renderClauseGroups:function(){var e,t=this
setTimeout(function(){_.each(conductor_query_builder.clauses,function(t,o){(t.config["default"]||conductor_query_builder.meta[o]&&!_.isEmpty(conductor_query_builder.meta[o]))&&(t.config["default"]?n.addClauseGroup(!1,o,t,conductor_query_builder.meta[o]):_.each(conductor_query_builder.meta[o],function(r,i){e=n.addClauseGroup(!1,o,t,conductor_query_builder.meta[o]),_.each(r,function(t,o){0!==o&&e.addSubClauseGroup()})}))}),t.removeLoadingState()},1)},reset:function(){var e,t,o,r=this
for(_.each(conductor_query_builder.meta,function(e,t){conductor_query_builder.meta[t]=[]}),n.trigger("conductor-qb-disable-action-buttons"),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.trigger("conductor-qb-disable-action-buttons")});s.length;)e=s.first(),t=e.get("el_selector"),t&&(o=r.views.get(t),o.length&&_.each(o,function(e){e.removeClauseGroup(!1,!0)}))},toggleQueryBuilderMode:function(e,t){this.$el.find("["+this.query_builder_mode_attr+'="'+t+'"]').addClass("hide hidden conductor-qb-hide conductor-qb-hidden"),this.$el.find("["+this.query_builder_mode_attr+'="'+e+'"]').removeClass("hide hidden conductor-qb-hide conductor-qb-hidden"),this.$el.parents(".conductor-qb-query-builder-meta-box-tab-content-wrapper").toggleClass("conductor-qb-"+t+"-mode conductor-qb-"+e+"-mode")},removeLoadingState:function(){this.$el.parents(".conductor-qb-query-builder-meta-box-tab-content-wrapper").removeClass(conductor_query_builder.css.classes.loading)}}),conductor_query_builder.Backbone.Views.Query_Builder_Actions=e.Backbone.View.extend({className:"conductor-qb-meta-box-query-builder-actions-inner",action_button_selector:".conductor-qb-action-button",el_selector:"",el_selector_prefix:".conductor-qb-meta-box-query-builder-",el_selector_suffix:"-actions",flags:{action_buttons_enabled:!1},template:e.template("conductor-qb-meta-box-query-builder-actions"),events:{"click .conductor-qb-add-clause-group-button":function(e){var o,r=t(e.currentTarget),i=r.data("clause-group-type"),n=conductor_query_builder.clauses[i]&&conductor_query_builder.clauses[i].config,s=n&&n.limit?parseInt(n.limit,10):-1
o=this.addClauseGroup(e),o&&-1!==s&&o.getCurrentCount()>=s&&this.disableActionButton("#"+r.attr("id"))},"click .conductor-qb-test-query-button":"testQuery","click .conductor-qb-toggle-mode-button":"toggleQueryBuilderMode"},initialize:function(e){_.bindAll(this,"render","addClauseGroup"),e.flags||(e.flags={}),this.el_selector=e.clause_group_type?this.el_selector_prefix+e.clause_group_type+this.el_selector_suffix:this.el_selector_prefix+this.el_selector_suffix,e.clause_group_type&&!t(this.el_selector).length&&(this.el_selector=this.el_selector_prefix+e.clause_group_type.replace("_","-")+this.el_selector_suffix),e.clause_group_type||(this.el_selector=this.el_selector.replace("--","-")),!e.flags.clause_group&&e.clause_group_type&&(e.flags.clause_group=!0),this.listenTo(this,"conductor-qb-enable-action-buttons",this.enableActionButtons),this.listenTo(this,"conductor-qb-disable-action-buttons",this.disableActionButtons)},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this},addClauseGroup:function(e,o,r,n){o=o||!1,r=r||!1,n=n||!1
var c,u,a,l,d=e&&!_.isEmpty(e),p=d&&e.currentTarget?t(e.currentTarget):!1,b=o?o:p?p.data("clause-group-type"):!1,h=r.config,y=h&&h.title||"",f=h&&h.limit?parseInt(h.limit,10):-1
return d&&e.preventDefault(),b?(c=new conductor_query_builder.Backbone.Models.Query_Builder_Clause_Group({columns:conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].config&&conductor_query_builder.clauses[b].config.columns?conductor_query_builder.clauses[b].config.columns:!1,flags:conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].config&&conductor_query_builder.clauses[b].config.flags?conductor_query_builder.clauses[b].config.flags:!1,operators:conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].operators?conductor_query_builder.clauses[b].operators:!1,parameters:conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].parameters?conductor_query_builder.clauses[b].parameters:!1,meta:n?n:conductor_query_builder.meta[b]?conductor_query_builder.meta[b]:_.clone(conductor_query_builder.Backbone.defaults.meta),title:!y&&conductor_query_builder.clauses[b]&&conductor_query_builder.clauses[b].config&&conductor_query_builder.clauses[b].config.title?conductor_query_builder.clauses[b].config.title:y,type:b,limit:!isNaN(f)&&f>0?f:-1,shortcode:this.options.shortcode}),s.add(c),conductor_query_builder.Backbone.instances.models.clauses.push(c),u=_.clone(c.attributes),u.model=c,a=new conductor_query_builder.Backbone.Views.Query_Builder_Clause_Group(u),conductor_query_builder.Backbone.instances.views.clauses.push(a),c.setID(a),u.flags.actions&&(l=new conductor_query_builder.Backbone.Views.Query_Builder_Actions({type:"query-builder-actions",clause_group_type:u.type,shortcode:this.options.shortcode}),conductor_query_builder.Backbone.instances.views.clause_action_buttons.push(l),a.views.set(l.el_selector,l,{silent:!0})),i.views.add(a.el_selector,a),a):!1},enableActionButtons:function(){this.flags.action_buttons_enabled=!0,this.enableActionButton(this.action_button_selector)},enableActionButton:function(e){var o=this.$el.find(e)
o.length||(e=e.replace("_","-"),o=this.$el.find(e)),o.length&&(o.length>1?o.each(function(){var e=t(this),o=e.data("clause-group-type"),r=conductor_query_builder.clauses[o]&&conductor_query_builder.clauses[o].config,i=r&&r.limit?parseInt(r.limit,10):-1,n=s.where({type:o}).length
0===n&&conductor_query_builder.meta[o]&&(n=conductor_query_builder.meta[o].length),(-1===i||i>n)&&e.prop("disabled",!1)}):this.$el.find(e).prop("disabled",!1))},disableActionButtons:function(){this.flags.action_buttons_enabled=!1,this.disableActionButton(this.action_button_selector)},disableActionButton:function(e){var t=this.$el.find(e)
t.length&&this.$el.find(e).prop("disabled",!0)},testQuery:function(e){e.preventDefault()},toggleQueryBuilderMode:function(e){var o,r=t(e.currentTarget),n=conductor_query_builder.user.settings["query-builder"].mode.value
e.preventDefault(),o=_.find(conductor_query_builder.user.settings["query-builder"].mode.values,function(e,t){return conductor_query_builder.user.settings["query-builder"].mode.values.indexOf(n)!==t}),r.html(r.data(o+"-label")),window.setUserSetting(conductor_query_builder.user.settings["query-builder"].mode.name,o),conductor_query_builder.user.settings["query-builder"].mode.value=o,i.toggleQueryBuilderMode(o,n)}}),conductor_query_builder.Backbone.Views.Query_Builder_Clause_Group=e.Backbone.View.extend({className:"conductor-qb-meta-box-query-builder-clause-group-inner",el_selector:"",el_selector_prefix:".conductor-qb-meta-box-query-builder-",el_selector_suffix:"-groups",select2_selector:".conductor-qb-select2",$select2:!1,template:e.template("conductor-qb-meta-box-query-builder-clause-group"),events:{"click .conductor-qb-remove-action-button":function(e){var o,r,i,s=t(e.currentTarget),c="#"+s.data("action-button-id"),u=t(c)
u.length||(c=c.replace("_","-"),u=t(c)),u.length&&(r=u.data("clause-group-type"),o=conductor_query_builder.clauses[r]&&conductor_query_builder.clauses[r].config,i=o&&o.limit?parseInt(o.limit,10):-1),n.flags.action_buttons_enabled&&i&&this.getCurrentCount()<=i&&(n.enableActionButton(c),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.enableActionButton(c)})),this.removeClauseGroup(e)},"click .conductor-qb-add-action-button":"addSubClauseGroup"},initialize:function(e){_.bindAll(this,"render","addSubClauseGroup","removeSubClauseGroup","removeClauseGroup","select2Change","getCurrentCount"),e.flags||(e.flags={}),e.type&&(this.el_selector=this.el_selector_prefix+e.type+this.el_selector_suffix,t(this.el_selector).length||(this.el_selector=this.el_selector_prefix+e.type.replace("_","-")+this.el_selector_suffix),this.model.set("el_selector",this.el_selector)),this.options.count=this.getCurrentCount(!0),_.isUndefined(this.options.flags.sub_clause_groups)&&(this.options.flags.sub_clause_groups=!0),_.isUndefined(this.options.flags.remove)&&(this.options.flags.remove=!0),_.isUndefined(this.options.flags.re_init_values)&&(this.options.flags.re_init_values=!1),e.template&&(this.template=e.template),this.listenTo(this,"ready",this.addSubClauseGroup)},addSubClauseGroup:function(e){e=e||!1
var o,r,i,n,s=e&&!_.isEmpty(e)
s&&e.currentTarget?t(e.currentTarget):!1;(!s||this.options.flags.sub_clause_groups)&&(s&&e.preventDefault(),o={columns:this.options.columns,flags:this.options.flags,operators:this.options.operators,parameters:this.options.parameters,type:this.options.type,shortcode:this.options.shortcode},r=new conductor_query_builder.Backbone.Models.Query_Builder_Sub_Clause_Group(o),c.add(r),conductor_query_builder.Backbone.instances.models.sub_clauses.push(r),i=_.clone(r.attributes),i.model=r,n=new conductor_query_builder.Backbone.Views.Query_Builder_Sub_Clause_Group(i),conductor_query_builder.Backbone.instances.views.sub_clauses.push(n),r.setID(n),this.views.add(n.el_selector,n),this.options.sub_clause_el_selector&&this.options.sub_clause_el_selector===n.el_selector||(this.options.sub_clause_el_selector=n.el_selector))},removeSubClauseGroup:function(e,t){e.preventDefault(),this.options.flags.sub_clause_groups&&!t.options["default"]&&(t.remove(),r.previewQuery())},render:function(t){return t=t||!1,this.options.count=t?this.options.count-1:this.options.count,t&&this.model.setID(this),e.Backbone.View.prototype.render.apply(this,arguments),this},removeClauseGroup:function(e,t){t=t||!1
var o=e&&!_.isEmpty(e);(this.options.flags.remove||t)&&(o&&e.preventDefault(),this.remove(t),r.previewQuery())},remove:function(t){t=t||!1
var o,r,i,n=conductor_query_builder.Backbone.instances.views.clauses,c=this.model.get("type"),u=this.options.count
if(this.options.flags.remove||t)return this.options.flags.removing||(this.options.flags.removing=!0),s.remove(this.model),o=e.Backbone.View.prototype.remove.apply(this,arguments),r=n.map(function(e){return e.cid}).indexOf(this.cid),-1!==r&&n.splice(r,1),-1!==u&&conductor_query_builder.meta[c][u]&&conductor_query_builder.meta[c].splice(u,1),i=n.filter(function(e){return e.options.type===c}),i.length&&_.each(i,function(e){!e.options.flags.removing&&e.options.count>u&&(e.render(!0),e.options.flags.re_rendering=!0,e.options.sub_clause_el_selector&&_.each(e.views.get(e.options.sub_clause_el_selector),function(e){e.render(!0)}),e.options.flags.re_rendering=!1)}),o},select2Change:function(e,o){var r,i,n,s=t(e.currentTarget),c=o.$select2.filter('[data-type="parameters"]'),u=c.find("option"),a=u.filter(":selected"),l=a.data("parameter"),d=a.data("field"),_=o.$select2.filter('[data-type="operators"]'),p=_.find("option"),b=_.val(),h=o.$select2.filter('[data-type="values"]'),y=h.find("option"),f=h.val(),m=s.val(),g=s.data("type"),q=s.data("select-type"),v=this.model.get("columns")
switch(g){case"parameters":if(this.options.flags.re_init_values=!1,r=this.getParameterData(m,l,d,q),i=this.getOperators(r),n=this.getValues(m,q),!(i&&i.length&&_.length&&m))return
this.updateOperatorsSelect(_,p,b,i),_.prop("disabled")&&_.prop("disabled",!1),v&&v.values&&n&&(this.options.flags.re_init_values=this.updateValuesSelect(h,y,f,n))
break
case"operators":v&&v.values&&(h.prop("disabled")&&conductor_query_builder.operators[m]&&("string"==typeof conductor_query_builder.operators[m]||conductor_query_builder.operators[m].type&&"bool"!==conductor_query_builder.operators[m].type)?h.prop("disabled",!1):!h.prop("disabled")&&conductor_query_builder.operators[m]&&"string"!=typeof conductor_query_builder.operators[m]&&conductor_query_builder.operators[m].type&&"bool"===conductor_query_builder.operators[m].type&&h.prop("disabled",!0))}},getCurrentCount:function(e){e=e||!1
var t
return t=s.where({type:this.options.type}).length,t=e&&0!==t?t-1:t},getParameterData:function(e,t,o,r){var i,n=e&&"string"==typeof e&&conductor_query_builder.parameters[e]?conductor_query_builder.parameters[e]:!1,s=void 0!==conductor_query_builder.parameters[r]
return(!n||s||!n.operators&&t&&r&&(conductor_query_builder.parameters[t]||conductor_query_builder.parameters[r]))&&(n=!n&&conductor_query_builder.parameters[t]?conductor_query_builder.parameters[t]:n,(!n||s||!n.operators&&t!==r&&conductor_query_builder.parameters[r])&&(i=conductor_query_builder.parameters[r]),i&&_.isObject(i)&&!i.operators&&i.fields&&i.fields[o]&&(n=i.fields[o])),n},getOperators:function(e){var t
return t=_.isObject(e)&&e.operators?e.operators:[e],t=_.isObject(t)?_.values(t):t},getValues:function(e,t){var o="string"==typeof e?conductor_query_builder.values[e]:!1
return!o&&t&&conductor_query_builder.values[t]&&(o=conductor_query_builder.values[t],o&&_.isObject(o)&&o.hasOwnProperty(e)&&(o=o[e])),o},updateOperatorsSelect:function(e,o,r,i,n){n=n||!1,o.each(function(){var e=t(this),o=(e.data("multiple"),e.val())
e.prop("disabled",-1===i.indexOf(o))}),o.filter('[value="'+r+'"]').prop("disabled")&&(e.val(o.not(":disabled").first().val()),n||e.trigger("change"))},updateValuesSelect:function(e,o,r,i,n){n=n||!1
var s=e.val(),c=!1
return _.each(i,function(t,r){var i,n,s
r=_.isObject(t)?r:t,r=_.isObject(t)&&t.hasOwnProperty("value")?t.value:r,n=o.filter('[value="'+r+'"]'),s=n.length?n.text():"",n.length?(_.isObject(t)&&t.hasOwnProperty("label")||s===r)&&s===t.label||(n.text(_.isObject(t)&&t.hasOwnProperty("label")?t.label:r),c||(c=!0)):(i='<option value="'+r+'">',i+=_.isObject(t)&&t.hasOwnProperty("label")?t.label:r,i+="</option>",e.append(i))}),o.each(function(){var e,o=t(this),n=o.val()
e=_.findIndex(i,function(e){return"string"==typeof e?e==n:e.value==n}),-1===e&&(o.remove(),r&&("string"==typeof r&&n==r||"string"!=typeof r&&r.length&&-1!==r.indexOf(n))&&("string"==typeof r?r="":r.splice(r.indexOf(n),1)))}),(!s&&r||r&&("string"==typeof s&&"string"==typeof r&&s!==r||"string"!=typeof r&&r.length&&!_.isEqual(s,r)))&&(e.val(r),n||e.trigger("change")),c}}),conductor_query_builder.Backbone.Views.Query_Builder_Sub_Clause_Group=e.Backbone.View.extend({className:"conductor-qb-meta-box-query-builder-sub-clause-group-inner",el_selector:"",el_selector_prefix:".conductor-qb-meta-box-query-builder-",el_selector_suffix:"-sub-clause-groups",select2_selector:".conductor-qb-select2",$select2:!1,values:{},template:e.template("conductor-qb-meta-box-query-builder-sub-clause-group"),events:{"click .conductor-qb-remove-action-button":"removeSubClauseGroup","change .conductor-qb-select2":"select2Change","select2:close .conductor-qb-select2":"select2Close"},initialize:function(e){_.bindAll(this,"render","removeSubClauseGroup","select2Change","select2Close","setMetaValue","getCurrentCount"),e.flags||(e.flags={}),e.type&&(this.el_selector=this.el_selector_prefix+e.type+this.el_selector_suffix,t(this.el_selector).length||(this.el_selector=this.el_selector_prefix+e.type.replace("_","-")+this.el_selector_suffix)),this.options.count=this.getCurrentCount(!0),this.options.count=-1!==this.options.count?this.options.count:0,this.options.parent||(this.options.parent={}),this.options.parent.count=this.views.parent&&this.views.parent.options.hasOwnProperty("count")&&-1!==this.views.parent.options.count?this.views.parent.options.count:-1,this.options.parent.limit=this.views.parent&&this.views.parent.options.hasOwnProperty("limit")&&-1!==this.views.parent.options.limit?this.views.parent.options.limit:-1,this.options.flags["default"]=0===this.options.count,e.template&&(this.template=e.template),this.listenToOnce(this,"ready",this.initializeSelect2),this.listenToOnce(this,"ready",this.maybeEnableActionButtons),this.listenToOnce(this,"ready",this.maybeSetModelID),this.listenToOnce(this,"ready",this.maybeSetModelParentData)},initializeSelect2:function(e){e=e||[]
var o,r,i,n,s,c=this,u=this.$el.find(this.select2_selector),a=u.filter('[data-type="operators"]'),l=a.find("option"),d=u.filter('[data-type="values"]'),p=d.find("option"),b=this.views.parent.model.get("columns")
this.$select2=u,u.each(function(){var u,h=t(this),y={},f=h.data("select2"),m=[],g=[],q=h.data("select-type"),v=h.data("type"),w=h.val(),B=c.getMeta()
if(!e.length||-1!==e.indexOf(v)){if(c.options.columns[v]&&c.options.columns[v].select2&&c.options.columns[v].select2.tags){if(y.tags=!0,!f)switch(w=B.values,r=B.parameters&&"string"==typeof B.parameters&&conductor_query_builder.clauses[q]&&conductor_query_builder.clauses[q].parameters?conductor_query_builder.clauses[q].parameters:!1,r=r&&"string"==typeof B.parameters&&r[B.parameters]&&r[B.parameters].field?r[B.parameters].field:"string"==typeof B.parameters?B.parameters:!1,B.parameters&&!r&&(o=B.parameters.slice(0),r=o&&conductor_query_builder.clauses[q]&&conductor_query_builder.clauses[q].parameters&&conductor_query_builder.clauses[q].parameters?conductor_query_builder.clauses[q].parameters:!1,r=r&&r[o]&&r[o].field?r[o].field:!1),v){case"values":i=c.views.parent.getParameterData(w,o?o:B.parameters,r,q),n=c.views.parent.getOperators(i),s=c.views.parent.getValues(o?o:B.parameters,q),n&&n.length&&a.length&&(c.views.parent.updateOperatorsSelect(a,l,B.operators&&"string"==typeof B.operators?B.operators:B.operators.slice(0),n,!0),b&&b.values&&s&&(c.views.parent.updateValuesSelect(d,p,w,s,!0),p=d.find("option")),w&&w.length&&!_.isEqual(w,s)&&_.each(w,function(e){p.filter('[value="'+e+'"]').length||(y.hasOwnProperty("data")||(y.data=[]),y.data.push(e))}))}y.tokenSeparators=c.options.columns[v].select2.tags}switch(c.options.shortcode&&(y.dropdownParent=t("#TB_ajaxContent")),h.select2(y),v){case"parameters":a.prop("disabled")&&B.parameters&&a.prop("disabled",!1),r=B.parameters&&"string"==typeof B.parameters&&conductor_query_builder.clauses[q]&&conductor_query_builder.clauses[q].parameters?conductor_query_builder.clauses[q].parameters:!1,r=r&&"string"==typeof B.parameters&&r[B.parameters]&&r[B.parameters].field?r[B.parameters].field:"string"==typeof B.parameters?B.parameters:!1,B.parameters&&!r&&(o=B.parameters.slice(0),r=o&&conductor_query_builder.clauses[q]&&conductor_query_builder.clauses[q].parameters&&conductor_query_builder.clauses[q].parameters?conductor_query_builder.clauses[q].parameters:!1,r=r&&r[o]&&r[o].field?r[o].field:!1),i=i?i:c.views.parent.getParameterData(w,o?o:B.parameters,r,q),n=!n&&i?c.views.parent.getOperators(i):n,n&&n.length&&a.length&&c.views.parent.updateOperatorsSelect(a,l,B.operators&&"string"==typeof B.operators?B.operators:B.operators.slice(0),n,!0)
break
case"operators":b&&b.values&&(d.prop("disabled")&&conductor_query_builder.operators[w]&&("string"==typeof conductor_query_builder.operators[w]||conductor_query_builder.operators[w].type&&"bool"!==conductor_query_builder.operators[w].type)?d.prop("disabled",!1):!d.prop("disabled")&&conductor_query_builder.operators[w]&&"string"!=typeof conductor_query_builder.operators[w]&&conductor_query_builder.operators[w].type&&"bool"===conductor_query_builder.operators[w].type&&d.prop("disabled",!1))
break
case"values":B.values&&(w=h.val(),_.isEqual(w,B.values)||(h.val(B.values).trigger("change"),w=h.val()))}f=h.data("select2"),u=f.$element.attr("class").split(/\s+/),u=u.map(function(e){return-1===e.indexOf("select2")?e:""}).filter(function(e){return e}),_.each(u,function(e){m.push(e+"-select2"),m.push(e+"-select2-container"),g.push(e+"-select2"),g.push(e+"-select2-results")}),m=m.join(" "),g=g.join(" "),f.$container.addClass(m),f.$results.addClass(g),c.setMetaValue(v,w)}})},maybeEnableActionButtons:function(){var e=this.$el.find(this.select2_selector)
e.each(function(){var e=t(this),o=e.val(),r=e.data("toggle-action-buttons")
return r&&o&&o.length?(n.trigger("conductor-qb-enable-action-buttons"),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.trigger("conductor-qb-enable-action-buttons")}),!1):void 0})},maybeSetModelID:function(e){e=e||!1
var t=this.model.get("id"),o=this.model.getIDFromView(this);(!t||o&&t!==o||e)&&this.model.setID(this,o)},maybeSetModelParentData:function(e){e=e||!1
var t=this.model.get("parent")
this.views.parent&&this.views.parent.model&&(-1!==t.count||-1===this.options.parent.count)&&(t.id!==this.model.get("id")||t.count!==this.views.parent.options.count||t.limit!==this.views.parent.model.get("limit")||e)&&this.model.setParentData(this)},setupMetaValues:function(){var e=this.model.get("parent"),t=-1!==e.count?e.count:-1,o=this.options.count,r=this.getMeta()
this.views.parent&&this.views.parent.options.meta&&-1!==t&&-1!==o&&(this.views.parent.options.meta[t]&&this.views.parent.options.meta[t][o]?(r=_.clone(conductor_query_builder.Backbone.defaults.meta),_.each(this.views.parent.options.meta[t][o],function(e,t){r[t]=e}),this.model.set("meta",r),this.options.meta=r):(r=_.clone(conductor_query_builder.Backbone.defaults.meta),this.model.set("meta",r),this.options.meta=r))},destroySelect2:function(){var e=this.$el.find(this.select2_selector)
e.each(function(){var o=t(this),r=o.data("select2")
r&&e.select2("destroy")})},removeSubClauseGroup:function(e){e.preventDefault(),this.options["default"]||this.views.parent.removeSubClauseGroup(e,this)},render:function(t){return t=t||this.views.parent.options.flags.re_rendering||!1,this.maybeSetModelID(t),this.maybeSetModelParentData(t),this.options.count=t&&!this.views.parent.options.flags.re_rendering?this.options.count-1:this.getCurrentCount(!0),this.options.count=-1!==this.options.count?this.options.count:0,this.options.parent.count=this.views.parent&&this.views.parent.options.hasOwnProperty("count")?this.views.parent.options.count:-1,this.options.parent.limit=this.views.parent&&this.views.parent.options.hasOwnProperty("limit")?this.views.parent.options.limit:-1,this.options.parent_id=this.model.get("parent_id"),this.options.flags["default"]=0===this.options.count,this.views.parent&&_.isUndefined(this.views.parent.options.flags.sub_clause_groups)&&(this.options.flags.sub_clause_groups=!0),this.setupMetaValues(),e.Backbone.View.prototype.render.apply(this,arguments),t&&(this.listenToOnce(this,"ready",this.initializeSelect2),this.listenToOnce(this,"ready",this.maybeEnableActionButtons),this.trigger("ready")),this},remove:function(){var t,o,r=conductor_query_builder.Backbone.instances.views.sub_clauses,i=this.model.get("type"),n=this.views.parent,s=this.model.get("parent"),u=-1!==s.count?s.count:-1,a=this.options.count,l=this.el_selector
return this.destroySelect2(),c.remove(this.model),t=e.Backbone.View.prototype.remove.apply(this,arguments),o=r.map(function(e){return e.cid}).indexOf(this.cid),-1!==o&&r.splice(o,1),-1!==u&&-1!==a&&conductor_query_builder.meta[i][u]&&conductor_query_builder.meta[i][u]&&conductor_query_builder.meta[i][u][a]&&conductor_query_builder.meta[i][u].splice(a,1),n.options.flags.removing||_.each(n.views.get(l),function(e){-1!==e.options.count&&(e.options.parent.count!==u&&e.options.parent.count>u||e.options.count>a)&&e.render(!0)}),t},select2Change:function(e){var o=t(e.currentTarget),r=(o.data("select2"),o.val()),i=o.data("type"),s=o.data("toggle-action-buttons")
s&&(r&&r.length?(n.trigger("conductor-qb-enable-action-buttons"),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.trigger("conductor-qb-enable-action-buttons")})):(n.trigger("conductor-qb-disable-action-buttons"),_.each(conductor_query_builder.Backbone.instances.views.clause_action_buttons,function(e){e.trigger("conductor-qb-disable-action-buttons")}))),this.setMetaValue(i,r),this.views.parent.select2Change(e,this)},select2Close:function(){this.options.shortcode&&!function(e){setTimeout(function(){e.initializeSelect2(e.views.parent.options.flags.re_init_values?[]:["parameters","operators"])},1)}(this)},getMeta:function(){return this.model.get("meta")},setMetaValue:function(e,t){var o=this.getMeta(),r=this.model.get("type"),i=this.model.get("parent"),n=-1!==i.count?i.count:-1,s=this.options.count
o[e]=t,this.model.set("meta",o),this.options.meta=o,-1!==n&&-1!==s&&(conductor_query_builder.meta[r][n]||(conductor_query_builder.meta[r][n]=[]),conductor_query_builder.meta[r][n][s]||(conductor_query_builder.meta[r][n][s]=_.clone(conductor_query_builder.Backbone.defaults.meta)),conductor_query_builder.meta[r][n][s][e]&&_.isEqual(conductor_query_builder.meta[r][n][s][e],t)||(conductor_query_builder.meta[r][n][s][e]=t))},getCurrentCount:function(e){e=e||!1
var t
return this.model.get("parent_id")?(t=c.where({parent_id:this.model.get("parent_id")}).length,t=e&&0!==t?t-1:t):-1}}),conductor_query_builder.Backbone.Models.Shortcode=Backbone.Model.extend({defaults:{create_title:"",insert_query:"",insert_title:""},id_prefix:"conductor-qb-",initialize:function(){_.bindAll(this,"setID","removeFromInstances"),this.setID(),this.listenTo(this,"remove",this.removeFromInstances),this.listenTo(this,"remove",this.stopListening)},setID:function(){this.set("id",this.id_prefix+"shortcode")},removeFromInstances:function(){var e,t=conductor_query_builder.Backbone.instances.models.shortcode,o=this
e=t.map(function(e){return e.get("id")}).indexOf(o.get("id")),-1!==e&&t.splice(e,1)},getShortcode:function(e){e=e||{id:this.get("insert_query")}
var t=""
return e.id?(t+="["+conductor_query_builder.shortcode,_.each(e,function(e,o){e&&(t+=" "+o+'="'+e+'"')}),t+="]"):t}}),conductor_query_builder.Backbone.Collections.Shortcode=Backbone.Collection.extend({}),conductor_query_builder.Backbone.Views.Shortcode=e.Backbone.View.extend({el:"#conductor-qb-shortcode-wrapper",events:{"click .conductor-qb-shortcode-tabs .nav-tab":"switchShortcodeActionButton","click .conductor-qb-shortcode-action-button":"shortcodeActionButton","change #conductor-qb-shortcode-insert-query":"setInsertQuery","keyup #conductor-qb-shortcode-insert-title":"setInsertTitle","change #conductor-qb-shortcode-insert-title":"setInsertTitle","keyup #conductor-qb-shortcode-create-title":"setCreateTitle","change #conductor-qb-shortcode-create-title":"setCreateTitle"},initialize:function(e){_.bindAll(this,"render","switchShortcodeActionButton","shortcodeActionButton","setInsertQuery","setCreateTitle")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this},reset:function(){this.$el.find("#conductor-qb-shortcode-insert-title").val("").change(),this.$el.find("#conductor-qb-shortcode-insert-query").val("").change(),this.$el.find("#conductor-qb-shortcode-create-title").val("").change()},switchShortcodeActionButton:function(e){var o=t(e.currentTarget),r=o.data("shortcode-action")
d.options.button_type=r,d.options.label=conductor_query_builder.l10n.shortcode[r],d.render(),this.maybeToggleActionButton(r)},maybeToggleActionButton:function(e){var t,o=d.$el.find(".conductor-qb-shortcode-action-button")
switch(e=e||o.data("type")){case"insert":t=this.model.get("insert_query"),t||o.prop("disabled")?t&&o.prop("disabled")&&d.enableActionButton():d.disableActionButton()
break
case"create":t=this.model.get("create_title"),t||o.prop("disabled")?t&&o.prop("disabled")&&d.enableActionButton():d.disableActionButton()}},shortcodeActionButton:function(o){var r,i=t(o.currentTarget),n=i.data("type")
switch(o.preventDefault(),d.$el.find(".conductor-qb-loading").addClass("is-active conductor-qb-spinner-is-active"),n){case"insert":r=this.model.getShortcode({id:this.model.get("insert_query"),title:this.model.get("insert_title")}),r?send_to_editor(r):tb_remove(),d.$el.find(".conductor-qb-loading").removeClass("is-active conductor-qb-spinner-is-active")
break
case"create":e.ajax.post(conductor_query_builder.ajax.shortcode.action,this.ajax.setupAJAXData(conductor_query_builder.ajax.shortcode.nonce,conductor_query_builder.ajax.shortcode.action)).done(this.ajax.success).fail(this.ajax.fail),d.disableActionButton()}},setInsertQuery:function(e){var o=t(e.currentTarget),r=o.val()
this.model.set("insert_query",r),this.maybeToggleActionButton()},setInsertTitle:function(e){var o=t(e.currentTarget),r=o.val()
this.model.set("insert_title",r)},setCreateTitle:function(e){var o=t(e.currentTarget),r=o.val()
this.model.set("create_title",r),this.maybeToggleActionButton()},ajax:{data:{conductor_query_builder:1},setupAJAXData:function(e,o){var i=t.extend({nonce:e,nonce_action:o},r.ajax.data),n=l.$el.find(".conductor-qb-shortcode-create-form"),s=n.serializeArray()
return _.each(s,function(e){i[e.name]=e.value}),i},success:function(e){var t=l.model.getShortcode({id:e.ID,title:e.title})
t?(send_to_editor(t),conductor_query_builder.queries.push({ID:e.ID,post_title:e.title}),p.render()):tb_remove(),d.$el.find(".conductor-qb-loading").removeClass("is-active conductor-qb-spinner-is-active")},fail:function(e){d.enableActionButton()}}}),conductor_query_builder.Backbone.Views.Shortcode_Actions=e.Backbone.View.extend({id:"conductor-qb-shortcode-actions-inner",el_selector:"#conductor-qb-shortcode-actions",template:e.template("conductor-qb-shortcode-query-builder-actions"),initialize:function(e){_.bindAll(this,"render")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this},disableActionButton:function(){var e=this.$el.find(".conductor-qb-shortcode-action-button")
e.prop("disabled",!0)},enableActionButton:function(){var e=this.$el.find(".conductor-qb-shortcode-action-button")
e.prop("disabled",!1)}}),conductor_query_builder.Backbone.Views.Shortcode_Insert=e.Backbone.View.extend({id:"conductor-qb-shortcode-insert-inner",el_selector:"#conductor-qb-shortcode-insert",select2_selector:".conductor-qb-select2",template:e.template("conductor-qb-shortcode-query-builder-insert"),initialize:function(e){_.bindAll(this,"render")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this.initializeSelect2(),this},reset:function(){this.$el.find("#conductor-qb-shortcode-insert-title").val("").change(),this.$el.find("#conductor-qb-shortcode-insert-query").val("").change(),this.$el.find("#conductor-qb-shortcode-create-title").val("").change(),this.destroySelect2()},initializeSelect2:function(){var e=this
setTimeout(function(){e.$el.find(e.select2_selector).select2({dropdownParent:t("#TB_ajaxContent")})},1)},destroySelect2:function(){var e=this.$el.find(this.select2_selector)
e.each(function(){var o=t(this),r=o.data("select2")
r&&e.select2("destroy")})}}),conductor_query_builder.Backbone.Views.Shortcode_Create_Title=e.Backbone.View.extend({id:"conductor-qb-shortcode-create-title-inner",el_selector:"#conductor-qb-shortcode-create-title-content",template:e.template("conductor-qb-shortcode-query-builder-create-title"),initialize:function(e){_.bindAll(this,"render")},render:function(){return e.Backbone.View.prototype.render.apply(this,arguments),this}}),t(function(){var e,r=t("body"),i=t(document),n=t(".conductor-qb-tabs a"),s=t(".conductor-qb-add-shortcode")
o=t("#conductor-query-builder-preview"),n.on("click.conductor-qb",function(e){var o=t(this),r=o.siblings(),i=o.parents(".conductor-qb-tabs-wrapper"),n=i.next(".conductor-qb-tab-content-wrapper").find(".conductor-qb-tab"),s=o.attr("href")
n=n.filter('[data-type="'+o.data("type")+'"]'),e.preventDefault(),r.removeClass("nav-tab-active"),n.removeClass("active"),o.addClass("nav-tab-active"),t(s).addClass("active")}),conductor_query_builder.flags.is_query_builder_post_type&&conductor_query_builder.fn.query_builder.init(),s.on("click.conductor-qb",function(e){r.addClass("conductor-shortcode-ui-visible"),l?(conductor_query_builder.fn.shortcode.reset(),p.render(),conductor_query_builder.fn.query_builder.reset()):(conductor_query_builder.fn.shortcode.init(),conductor_query_builder.fn.query_builder.init(!0)),tb_show(conductor_query_builder.l10n.shortcode.title,"#TB_inline?inlineId=conductor-qb-shortcode-wrapper-container&width=753&height=480",!1)}),r.on("thickbox:removed",function(){r.hasClass("conductor-shortcode-ui-visible")&&(conductor_query_builder.fn.shortcode.reset(),conductor_query_builder.fn.query_builder.reset(),l.$el.find(".conductor-qb-tabs .nav-tab:first-child").trigger("click"),conductor_query_builder.fn.conductor.widget.reset(),setTimeout(function(){r.removeClass("conductor-shortcode-ui-visible")},1))}),i.on("keydown.conductor-qb",".select2-search__field, .select2-search--inline",function(e){r.hasClass("conductor-shortcode-ui-visible")&&27===e.which&&e.stopImmediatePropagation()}),i.on("keydown.conductor-qb",function(e){r.hasClass("conductor-shortcode-ui-visible")&&27===e.which&&(c.isMetaEmpty()||window.confirm(conductor_query_builder.l10n.shortcode.confirm)||e.stopImmediatePropagation())}),e=new MutationObserver(function(e){r.hasClass("conductor-shortcode-ui-visible")&&_.each(e,function(e){e.addedNodes&&e.addedNodes.length&&_.each(e.addedNodes,function(e){if("TB_window"===e.id){var o=t("#TB_overlay, #TB_closeWindowButton")
o.on("click.conductor-qb",function(e){r.hasClass("conductor-shortcode-ui-visible")&&(c.isMetaEmpty()||window.confirm(conductor_query_builder.l10n.shortcode.confirm)||e.stopImmediatePropagation())}),o.each(function(){var e,o=(t(this),jQuery._data(this,"events")),r=-1
o&&o.click&&o.click.length&&(_.each(o.click,function(e,t){"conductor-qb"===e.namespace&&(r=t)}),-1!==r&&(e=o.click.splice(r,1),e.length&&o.click.splice(0,0,e[0])),jQuery._data(this,"events",o))})}})})}),e.observe(r[0],{childList:!0})})}(wp,jQuery)
